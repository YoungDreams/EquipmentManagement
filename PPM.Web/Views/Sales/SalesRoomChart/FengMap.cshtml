@using PensionInsurance.Entities
@using PensionInsurance.Shared
@model PensionInsurance.Web.Views.Sales.SalesRoomChart.FengMapDetailViewMdoel
@section Styles{
    <link href=@Url.Content("~/assets/fengmap/css/common.css") rel="stylesheet" type="text/css" />
}
<style>
    .modalborder {
        border-bottom: 1px solid #e5e5e5;
        padding-left: 15px;
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .btns {
        position: absolute;
        left: 2%;
        bottom: 2%;
        color: #ffffff;
    }
</style>
@section Breadcrumb{
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <a href="@Url.Action("Index","Home")">首页</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <a href="#">销售管理</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <span>销控图</span>
            </li>
        </ul>
    </div>
}
<!-- END PAGE BAR -->
<form id="FengMapDetail" data-ajax="true" class="form-horizontal">
    <div id="map-container"></div>
    <div class="btns">
        <span class="btn" style="background-color: #7fb979">空房</span>
        <span class="btn" style="background-color: #fabb7c">已住人</span>
        <span class="btn" style="background-color: #aba8a5">已住满</span>
    </div>
    <!-- data-backdrop="false" -->
    <div id="dlgModelInfo" class="modal fade">
        <div class="modal-dialog bottom">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">房间信息</h4>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="col-md-6">房间号</div>
                                <div class="col-md-6" id="RommName"></div>
                            </div>
                            <div class="col-md-6">
                                <div class="col-md-6">房型</div>
                                <div class="col-md-6" id="RommType"></div>
                            </div>

                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="col-md-6">床位数量</div>
                                <div class="col-md-6" id="Beds"></div>
                            </div>
                            <div class="col-md-6">
                                <div class="col-md-6">床位价格</div>
                                <div class="col-md-6" id="BedPrice"></div>
                            </div>
                        </div>
                        <div id="fmcustomers">
                            
                        </div>

                    </div>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
</form>
@section Scripts{
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src=@Url.Content("~/assets/fengmap/lib/fengmap.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/fengmap/js/layerGroup.js") type="text/javascript"></script>
    <script type="text/javascript">
        var fmapID = '@Model.MapId';
        var map = null;
        var isImageMarker = false; //判断当前是否点击的是poi,控制点击公共设施的时候只弹出公共设施的信息框
        $(function () {
            //楼层控制控件配置参数
            var ctlOpt = new fengmap.controlOptions({
                position: fengmap.controlPositon.RIGHT_TOP
            });
            map = new fengmap.FMMap({
                container: $('#map-container')[0], //渲染dom
                mapServerURL: '@Url.Content("~/assets/fengmap/data/")' + fmapID, //地图数据位置
                mapThemeURL: '@Url.Content("~/assets/fengmap/data/theme")', //主题数据位置
                focusAlphaMode: true, //对不可见图层启用透明设置 默认为true
                focusAnimateMode: false, //关闭聚焦层切换的动画显示
                focusAlpha: 0.1, //对不聚焦图层启用透明设置，当focusAlphaMode = true时有效
                viewModeAnimateMode: true, //开启2维，3维切换的动画显示
                defaultScaleLevel: 2,
                defaultViewMode:fengmap.FMViewMode.MODE_2D,
                defaultControlsPose: fengmap.FMDirection.NORTH ,
                modelSelectedEffect: false,
                defaultMapScaleLevel: 20,
                defaultThemeName:'@Model.MapId',
                appName: 'cxm',           //开发者申请应用名称
                key: '73029a035116a4034019df42e8cbc1e9' //开发者申请应用下web服务的key,
            });

            //打开地图数据
            map.openMapById(fmapID); //sceneId
            map.showCompass = true;
            //地图加载完成事件
            map.on('loadComplete', function () {
                //创建楼层
                groupControl = new fengmap.scrollGroupsControl(map, ctlOpt);

                var freeArray = @Html.Raw(Json.Encode(Model.FreeRoomFids));
                var occupyArray= @Html.Raw(Json.Encode(Model.OccupyRoomFids));
                var allOccupyArray= @Html.Raw(Json.Encode(Model.AllOccupyRoomFids));
                $.each(freeArray, function (index, item) {
                    //alert(item);
                    fengmap.MapUtil.search(map, 'all', { FID: item }, function (result) {
                        var models = result;
                        //console.log(models.length);
                        if (models.length <= 0) return;
                        //修改模型颜色
                        var model = models[0];
                        model.setColor('#067e02', 0.5); //修改模型颜色
                    });
                });
                $.each(occupyArray, function (index, item) {
                    //alert(item);
                    fengmap.MapUtil.search(map, 'all', { FID: item }, function (result) {
                        var models = result;
                        //console.log(models.length);
                        if (models.length <= 0) return;
                        //修改模型颜色
                        var model = models[0];
                        model.setColor('#ff8209', 0.5); //修改模型颜色
                    });
                });
                $.each(allOccupyArray, function (index, item) {
                    //alert(item);
                    fengmap.MapUtil.search(map, 'all', { FID: item }, function (result) {
                        var models = result;
                        //console.log(models.length);
                        if (models.length <= 0) return;
                        //修改模型颜色
                        var model = models[0];
                        model.setColor('#605b5b', 0.5); //修改模型颜色
                    });
                });
            });



            var startPick = true; // 控制是否弹出信息框
            //点击事件
            //map.on('mapClickNode', function(node) {
            //    alert(node);
            //    console.log(node);
            //});
            map.on('mapClickNode', function (event) {
                //console.log('mapClickNode', event);
                if (event.nodeType == fengmap.FMNodeType.NONE) return;
                var model = event;
                if (!startPick) return;
                if (event.nodeType != fengmap.FMNodeType.MODEL)
                    model.o3d_.flash({
                        scale: 1.3,
                        time: 0.3
                    }); //闪烁·
                var d;
                if (event.nodeType == fengmap.FMNodeType.MODEL) {
                    //过滤掉点击poi时同时返回的model
                    if (isImageMarker) {
                        isImageMarker = false;
                        return;
                    }
                    //过滤类型为墙的model
                    if (event.typeID == '30000') {
                        //其他操作
                        return;
                    }
                    d = {
                        type: event.typeID,
                        fid: event.FID,
                        name: !event.name ? "暂无" : event.name,
                        gid: event.groupID,
                        groupID: event.groupID
                    };
                   
                    //高亮
                   // map.storeSelect(model);
                    $.get('@Url.Action("GetRommInfo", "SalesRoomChart")?fid=' + d.fid,
                        function (data) {
                            var hasPermission = '@WebAppContext.Current.User.HasPermission(ModuleType.销控图, Permission.查看客户销控图费用)';
                            if (data.resultCode == "200") {
                                $('#dlgModelInfo').modal('show');
                                $('#dlgModelInfo .modal-title').text('房间信息');
                                $('#dlgModelInfo #RommName').text(data.RommName);
                                $('#dlgModelInfo #RommType').text(data.RommType);
                                $('#dlgModelInfo #Beds').text(data.Beds);
                                $('#dlgModelInfo #BedPrice').text(data.BedCost);
                                if (data.FmCustomers != null) {
                                    var strhtml = "";
                                    $(data.FmCustomers).each(function (i, fmCustomer) {

                                        strhtml += "<div class=\"modalborder\">" + fmCustomer.BedName + "号床(" + fmCustomer.IsCompartment + ")</div>";
                                        strhtml += "<div class=\"row\">";
                                        strhtml += "<div class=\"col-md-6\">";
                                        strhtml += "<div class=\"col-md-6\">客户姓名</div>";
                                        strhtml += "<div class=\"col-md-6\">" + fmCustomer.Name + "</div>";
                                        strhtml += "</div>";
                                        strhtml += "<div class=\"col-md-6\">";
                                        strhtml += "<div class=\"col-md-6\">客户性别</div>";
                                        strhtml += "<div class=\"col-md-6\">" + fmCustomer.Sex + "</div>";
                                        strhtml += "</div>";
                                        strhtml += "</div>";

                                        strhtml += "<div class=\"row\">";
                                        strhtml += "<div class=\"col-md-6\">";
                                        strhtml += "<div class=\"col-md-6\">客户年龄</div>";
                                        strhtml += "<div class=\"col-md-6\">" + fmCustomer.Age + "</div>";
                                        strhtml += "</div>";
                                        strhtml += "<div class=\"col-md-6\">";
                                        strhtml += "<div class=\"col-md-6\">入住日期</div>";
                                        strhtml += "<div class=\"col-md-6\">" + fmCustomer.StarTime + "</div>";
                                        strhtml += "</div>";
                                        strhtml += "</div>";
                                        strhtml += "<div class=\"row\">";
                                        strhtml += "<div class=\"col-md-6\">";
                                        strhtml += "<div class=\"col-md-6\">生活能力类型</div>";
                                        strhtml += "<div class=\"col-md-6\">" + fmCustomer.NursingType + "</div>";
                                        strhtml += "</div>";
                                        if (hasPermission !="False")
                                        {
                                            strhtml += "<div class=\"col-md-6\">";
                                            strhtml += "<div class=\"col-md-6\">费用</div>";
                                            strhtml += "<div class=\"col-md-6\">" + fmCustomer.Cost + "</div>";
                                            strhtml += "</div>";
                                        }
                                        strhtml += "</div>";
                                    });
                                    $('#dlgModelInfo #fmcustomers').html(strhtml);
                                }
                            }
                        }
                    );
                } //打开对话框
                map.moveTo(d);
                //groupControl.changeFocusGroup(d.gid);
            });
        });
    </script>
}