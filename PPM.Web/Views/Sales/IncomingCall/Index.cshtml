@using PensionInsurance.Entities
@using PensionInsurance.Shared
@using PensionInsurance.Web.Common;
@model PensionInsurance.Web.Views.Sales.IncomingCall.IndexViewModel
@section Styles{
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/clockface/css/clockface.css") rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/assets/global/plugins/select2/css/select2-bootstrap.min.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/assets/global/plugins/select2/css/select2.min.css")" rel="stylesheet" type="text/css" />
    <!-- END PAGE LEVEL PLUGINS -->
}
<!-- BEGIN PAGE BAR -->
@section Breadcrumb{
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <a href="@Url.Action("Index","Home")">首页</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <a href="#">销售管理</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <span>电话管理</span>
            </li>
        </ul>
    </div>
}
<!-- END PAGE BAR -->
<div class="row" style="margin-top: 10px;">
    <div class="col-md-12">
        <div class="portlet">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-gift"></i>电话查询
                </div>
            </div>
            <div class="portlet-body form">
                <!-- BEGIN FORM-->
                <form id="incoming-call-search-form" action="@Url.Action("Index","IncomingCall",new {page = Model.Items.Page,pageSize = Model.Items.PageSize})" class="form-horizontal">
                    <div class="form-body">
                        <div class="row">
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-4">是否录入</label>
                                    <div class="col-md-8">
                                        @Html.DropDownListFor(m => m.Query.IsExist, true)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <div class="text-center"><button type="submit" class="btn green btn-sm padding-lf-15 " data-showloading="true">查询</button></div>
                    </div>
                </form>
                <!-- END FORM-->
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-phone font-green"></i>
                    <span class="caption-subject font-green bold uppercase">电话列表</span>
                </div>
                <div class="actions">
                    @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.电话管理, Permission.导出))
                    {
                        <a href="javascript:;" class="btn green incoming-call-export">
                            <i class="fa fa-rotate-right" aria-hidden="true"></i>
                            导出
                        </a>
                    }
                    @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.电话管理, Permission.导入))
                    {
                        <a class="btn green incoming-call-import" href="javascript:;">
                            <i class="fa fa-rotate-left" aria-hidden="true"></i>
                            导入
                        </a>
                    }
                    @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.电话管理, Permission.删除))
                    {
                        <a href="javascript:;" class="btn green incoming-call-delete">
                            <i class="fa fa-trash" aria-hidden="true"></i>
                            删除
                        </a>
                    }
                </div>
            </div>
            <div class="portlet-body">
                <div class="table table-scrollable">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>序号</th>
                                <th>来源</th>
                                <th>主叫号码</th>
                                <th>联系人</th>
                                <th>被叫号码</th>
                                <th>开始时间</th>
                                <th>结束时间</th>
                                <th>应扣除时长（分钟）</th>
                                <th>扣费金额</th>
                                <th>类型</th>
                                <th>客户号码归属地</th>
                                <th>呼入导航</th>
                                <th>已接坐席</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Items)
                            {
                                <tr>
                                    <td>@Model.Items.RowNumberOf(item)</td>
                                    <td>@item.Source</td>
                                    <td>@item.CallingPhoneNumber</td>
                                    <td>@item.ContactPhoneNumber</td>
                                    <td>@item.CalledPhoneNumber</td>
                                    <td>@(item.StartTime.HasValue ? item.StartTime.Value.DateTimeString() : "")</td>
                                    <td>@(item.EndTime.HasValue ? item.EndTime.Value.DateTimeString() : "")</td>
                                    <td>@item.Duration</td>
                                    <td>@item.Charged</td>
                                    <td>@item.AnsweredType</td>
                                    <td>@item.PhoneLocation</td>
                                    <td>@(item.Project?.Name)</td>
                                    <td>@(item.User?.RealName)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                @Html.Partial("_Pagination", Model.Items)
            </div>
        </div>
    </div>
</div>
<div class="modal small fade" id="incoming-call-delete-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 500px;">
        <div class="modal-content">
            <div class="modal-body">
                <div class="portlet box green">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-gift"></i>删除电话记录
                        </div>
                    </div>
                    <div class="portlet-body form">
                        <!-- BEGIN FORM-->
                        <div class="form-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <form data-ajax=true action="@Url.Action("Delete", "IncomingCall")" method="POST">
                                        <div class="portlet-body form">
                                            <!-- BEGIN FORM-->
                                            <div class="form-body">
                                                <div class="row">
                                                    <!--/span-->
                                                    <div class="col-md-12">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-3">开始日期范围</label>
                                                            <div class="col-md-3">
                                                                <input type="text" class="form-control form-control-inline date-picker" name="StartTime" data-date-format="yyyy-mm-dd">
                                                            </div>
                                                            <div class="col-md-1">
                                                                <span>到</span>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <input type="text" class="form-control form-control-inline date-picker" name="EndTime" data-date-format="yyyy-mm-dd">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="errors alert alert-danger fade in" style="display: none;"></div>
                                        <div class="form-actions">
                                            <div class="text-center">
                                                <button class="btn green btn-sm padding-lf-15">确定</button>
                                                <button type="button" class="btn yellow btn-sm padding-lf-15" data-dismiss="modal">返回</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal small fade" id="incoming-call-import-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 400px;">
        <div class="modal-content">
            <div class="modal-body">
                <div class="portlet box green">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-gift"></i>导入电话记录
                        </div>
                    </div>
                    <div class="portlet-body form">
                        <!-- BEGIN FORM-->
                        <div class="form-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <form id="fileupload" data-ajax=true action="@Url.Action("Import", "IncomingCall")" method="POST" enctype="multipart/form-data">
                                        <div class="portlet-body form">
                                            <!-- BEGIN FORM-->
                                            <div class="form-body">
                                                <div class="row">
                                                    <!--/span-->
                                                    <div class="col-md-4">
                                                        <div class="form-group">
                                                            <div class="fileinput fileinput-new" data-provides="fileinput">
                                                                <div class="input-group input-large">
                                                                    <div class="form-control uneditable-input input-fixed input-small" data-trigger="fileinput">
                                                                        <i class="fa fa-file fileinput-exists"></i>&nbsp;
                                                                        <span class="fileinput-filename"> </span>
                                                                    </div>
                                                                    <span class="input-group-addon btn default btn-file">
                                                                        <span class="fileinput-new">选择文件</span>
                                                                        <span class="fileinput-exists">替换</span>
                                                                        <input type="file" name="file">
                                                                    </span>
                                                                    <a href="javascript:;" class="input-group-addon btn red fileinput-exists" data-dismiss="fileinput">删除</a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="errors alert alert-danger fade in" style="display: none;"></div>
                                        <div class="form-actions">
                                            <div class="text-center">
                                                <button class="btn green btn-sm padding-lf-15">导入</button>
                                                <button type="button" class="btn yellow btn-sm padding-lf-15" data-dismiss="modal">返回</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts{
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src=@Url.Content("~/assets/global/plugins/moment.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/select2/js/select2.full.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/clockface/js/clockface.js") type="text/javascript"></script>
    <!-- END PAGE LEVEL PLUGINS -->
    <!-- BEGIN THEME GLOBAL SCRIPTS -->
    <script src=@Url.Content("~/assets/global/scripts/app.min.js") type="text/javascript"></script>
    <!-- END THEME GLOBAL SCRIPTS -->
    <script type="text/javascript">

        $(document).ready(function () {
            $(document).on("click",
                ".incoming-call-import",
                function () {
                    var importModal = $('#incoming-call-import-modal');
                    importModal.modal('show');
                    clearFormValues("incoming-call-import-modal");
                }).on("click", ".incoming-call-delete", function () {
                    var deleteModal = $('#incoming-call-delete-modal');
                    deleteModal.modal('show');
                    clearFormValues("incoming-call-delete-modal");
                });

            $(document).on("click", ".incoming-call-export", function () {
                var form = $("#incoming-call-search-form");
                var isExist = form.find("select[name='Query.IsExist']").val();
                var command = {
                    IsExist: isExist
                };
                App.confirm(function () {
                    form.postCommand('@Url.Action("Export", "IncomingCall")', command, {
                        onSuccess: function (result) {
                            window.location = "../" + result.redirect;
                        }
                    });
                });
            });
        });
    </script>
}