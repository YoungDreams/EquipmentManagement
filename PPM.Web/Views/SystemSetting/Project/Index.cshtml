@using PensionInsurance.Entities
@using PensionInsurance.Shared
@using PensionInsurance.Web.Common;
@model PensionInsurance.Web.Views.SystemSetting.Project.IndexViewModel

<!-- BEGIN PAGE BAR -->
@section Breadcrumb{
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <a href="@Url.Action("Index", "Home")">系统设置管理</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <span>项目管理</span>
            </li>
        </ul>
    </div>
}
<div class="row" style="margin-top: 10px;">
    <div class="col-md-12">
        <div class="portlet">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-search"></i>项目信息查询
                </div>
            </div>
            <div class="portlet-body form">
                <!-- BEGIN FORM-->
                <form action="@Url.Action("Index","Project")" class="form-horizontal">
                    <div class="form-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label col-md-3">查询关键字</label>
                                    <div class="col-md-9">
                                        @Html.InputText(m => m.Query.Keywords)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <div class="text-center">
                            <button type="submit" class="btn green btn-sm padding-lf-15 ">查询</button>
                        </div>
                    </div>
                </form>
                <!-- END FORM-->
            </div>
        </div>
    </div>
</div>
<div class="row" style="margin-top: 10px;">
    <div class="col-md-12">
        <div class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-social-dribbble font-green"></i>
                    <span class="caption-subject font-green bold uppercase">项目管理列表</span>
                </div>
            </div>
            <div class="portlet-body">
                <div class="table-toolbar">
                    <div class="row">
                        <div class="col-md-6">
                            @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.项目管理, Permission.新增))
                            {
                                <a href="@Url.Action("Create", "Project")" class="btn green">
                                    <i class="fa fa-plus" aria-hidden="true"></i>
                                    新增
                                </a>
                            }
                            @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.项目管理, Permission.启用))
                            {
                                <a id="valid" href="javascript:;" class="btn green disabled batch-button">
                                    <i class="fa fa-unlock" aria-hidden="true"></i>
                                    启用
                                </a>
                            }
                            @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.项目管理, Permission.失效))
                            {
                                <a id="invalid" href="javascript:;" class="btn green disabled batch-button">
                                    <i class="fa fa-unlock-alt" aria-hidden="true"></i>
                                    失效
                                </a>
                            }
                        </div>
                    </div>
                </div>
                <table id="project-items" class="table table-striped table-hover" data-src="@Url.Action("Index", "Project")">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" class="group-checkable" />
                            </th>
                            <th>项目编号</th>
                            <th>项目名称</th>
                            <th>项目地点</th>
                            <th>所属城市</th>
                            <th>公司名称</th>
                            <th>项目状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var project in Model.Projects)
                        {
                            <tr>
                                <td>
                                    <input type="checkbox" class="checkboxes" value="@project.Id" />
                                </td>
                                <td>@project.ProjectNo</td>
                                <td>@project.Name</td>
                                <td>@project.Address</td>
                                <td>@(project.City?.ShortName)</td>
                                <td>@project.CompanyName</td>
                                <td>@Html.RenderProjectStatus(project.Status)</td>
                                <td>
                                    <div class="btn-group dropup">
                                        <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                            审批人管理
                                            <i class="fa fa-angle-down"></i>
                                        </button>
                                        <ul class="dropdown-menu" role="menu">
                                            <li>
                                                <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.入住合同">@WorkflowCategory.入住合同</a>
                                            </li>
                                            <li class="dropdown-submenu">
                                                <a href="javascript:;">费用变更补充协议</a>
                                                <ul class="dropdown-menu" style="">
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.费用变更增加"> @WorkflowCategory.费用变更增加 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.费用变更减少不累计额度"> @WorkflowCategory.费用变更减少不累计额度 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.费用变更减少限额内"> @WorkflowCategory.费用变更减少限额内 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.费用变更减少限额外"> @WorkflowCategory.费用变更减少限额外 </a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li>
                                                <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.服务包补充协议">@WorkflowCategory.服务包补充协议</a>
                                            </li>
                                            <li>
                                                <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.换房补充协议">@WorkflowCategory.换房补充协议</a>
                                            </li>
                                            <li>
                                                <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.客户退住退款">@WorkflowCategory.客户退住退款</a>
                                            </li>
                                            <li class="dropdown-submenu">
                                                <a href="javascript:;">账单减免</a>
                                                <ul class="dropdown-menu" style="">
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.账单减免不累计额度"> @WorkflowCategory.账单减免不累计额度 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.账单减免累计限额内"> @WorkflowCategory.账单减免累计限额内 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.账单减免累计限额外"> @WorkflowCategory.账单减免累计限额外 </a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li>
                                                <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.转账">@WorkflowCategory.转账</a>
                                            </li>
                                            <li>
                                                <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.客户退住通知单">@WorkflowCategory.客户退住通知单</a>
                                            </li>
                                            <li>
                                                <a href="javascript:;" class="user-Configure-edit" data-id="@project.Id" data-category="@ConfigureCategory.库存盘点">@ConfigureCategory.库存盘点</a>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="btn-group dropup">
                                        <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                            采购审批
                                            <i class="fa fa-angle-down"></i>
                                        </button>
                                        <ul class="dropdown-menu" role="menu">
                                            <li class="dropdown-submenu">
                                                <a href="javascript:;">计划采购</a>
                                                <ul class="dropdown-menu" style="">
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.计划采购审批"> @WorkflowCategory.计划采购审批 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.计划采购验收"> @WorkflowCategory.计划采购验收 </a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li class="dropdown-submenu">
                                                <a href="javascript:;">餐饮部计划采购</a>
                                                <ul class="dropdown-menu" style="">
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.餐饮部计划采购审批"> @WorkflowCategory.餐饮部计划采购审批 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.餐饮部计划采购验收"> @WorkflowCategory.餐饮部计划采购验收 </a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li class="dropdown-submenu">
                                                <a href="javascript:;">运营紧急采购</a>
                                                <ul class="dropdown-menu" style="">
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.紧急采购审批"> @WorkflowCategory.紧急采购审批 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.紧急采购验收"> @WorkflowCategory.紧急采购验收 </a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li class="dropdown-submenu">
                                                <a href="javascript:;">食材紧急采购</a>
                                                <ul class="dropdown-menu" style="">
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.食材紧急采购审批"> @WorkflowCategory.食材紧急采购审批 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.食材紧急采购验收"> @WorkflowCategory.食材紧急采购验收 </a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li class="dropdown-submenu">
                                                <a href="javascript:;">食材采购</a>
                                                <ul class="dropdown-menu" style="">
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.食材采购审批"> @WorkflowCategory.食材采购审批 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.食材采购验收"> @WorkflowCategory.食材采购验收 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.食材采购确认"> @WorkflowCategory.食材采购确认 </a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li class="dropdown-submenu">
                                                <a href="javascript:;">营销类计划采购</a>
                                                <ul class="dropdown-menu" style="">
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.营销类计划采购审批"> @WorkflowCategory.营销类计划采购审批 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.营销类计划采购验收"> @WorkflowCategory.营销类计划采购验收 </a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li class="dropdown-submenu">
                                                <a href="javascript:;">营销类特殊采购</a>
                                                <ul class="dropdown-menu" style="">
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.营销类特殊采购审批"> @WorkflowCategory.营销类特殊采购审批 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.营销类特殊采购验收"> @WorkflowCategory.营销类特殊采购验收 </a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li class="dropdown-submenu">
                                                <a href="javascript:;">营销类紧急采购</a>
                                                <ul class="dropdown-menu" style="">
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.营销类紧急采购审批"> @WorkflowCategory.营销类紧急采购审批 </a>
                                                    </li>
                                                    <li>
                                                        <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.营销类紧急采购验收"> @WorkflowCategory.营销类紧急采购验收 </a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li>
                                                <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.固定资产采购验收">@WorkflowCategory.固定资产采购验收</a>
                                            </li>
                                            <li>
                                                <a href="javascript:;" class="workflow-contract-edit" data-id="@project.Id" data-category="@WorkflowCategory.盘点审批">@WorkflowCategory.盘点审批</a>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="btn-group dropup">
                                        <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                            人力审批
                                            <i class="fa fa-angle-down"></i>
                                        </button>
                                        <ul class="dropdown-menu" role="menu">
                                            <li>
                                                <a href="javascript:;" class="workflow-employee-edit" data-id="@project.Id" data-category="@WorkflowCategory.项目新员工入职">@WorkflowCategory.项目新员工入职</a>
                                            </li>
                                            <li>
                                                <a href="javascript:;" class="workflow-employee-edit" data-id="@project.Id" data-category="@WorkflowCategory.项目经理级新员工入职">@WorkflowCategory.项目经理级新员工入职</a>
                                            </li>
                                            <li>
                                                <a href="javascript:;" class="workflow-employee-edit" data-id="@project.Id" data-category="@WorkflowCategory.公寓总经理新员工入职">@WorkflowCategory.公寓总经理新员工入职</a>
                                            </li>
                                            <li>
                                                <a href="javascript:;" class="workflow-employee-edit" data-id="@project.Id" data-category="@WorkflowCategory.大区总监级新员工储备入职">@WorkflowCategory.大区总监级新员工储备入职</a>
                                            </li>
                                            <li>
                                                <a href="javascript:;" class="workflow-employee-edit" data-id="@project.Id" data-category="@WorkflowCategory.入职办理">@WorkflowCategory.入职办理</a>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="btn-group dropup">
                                        <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                            项目维护
                                            <i class="fa fa-angle-down"></i>
                                        </button>
                                        <ul class="dropdown-menu" role="menu">
                                            @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.项目管理, Permission.编辑))
                                            {
                                                <li>
                                                    <a href="@Url.Action("Edit", "Project", new {id = project.Id})">编辑</a>
                                                </li>
                                            }
                                            @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.项目管理, Permission.删除))
                                            {
                                                <li>
                                                    <a href="javascript:;" data-command="@Model.DeleteCommand(project.Id).ToJavascript()">删除</a>
                                                </li>
                                            }
                                            <li>
                                                <a href="@Url.Action("Index", "Room", new {ProjectId = @project.Id})">房间管理</a>
                                            </li>
                                            <li>
                                                <a href="@Url.Action("Index", "ProjectServicePackCatalog", new {ProjectId = @project.Id})">服务项目</a>
                                            </li>
                                            <li>
                                                <a href="javascript:;" data-projectid="@project.Id" data-projectname="@project.Name" class="addProjectOccupation" role="button">添加岗位</a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="modal small fade" id="configProjectOccupation" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog" style="width:400px;">
                    <form data-ajax="true" action="#" method="POST" class="form-horizontal" data-refresh="#items">
                        <div class="modal-content">
                            <div class="modal-body">
                                <div class="portlet box green">
                                    <div class="portlet-title">
                                        <div class="caption">
                                            <i class="fa fa-gift"></i>添加项目岗位
                                        </div>
                                    </div>
                                    <div class="portlet-body form">
                                        <!-- BEGIN FORM-->
                                        <div class="form-body">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-3">项目</label>
                                                        <div class="col-md-9">
                                                            <label id="addProjectName"></label>
                                                            <input type="hidden" id="projectIdToConfig" name="ProjectId" value="" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-3">岗位</label>
                                                        <div class="col-md-9">
                                                            <select name="HRJobOccupationId" class="form-control input-xs">
                                                                <option value="">--未选择--</option>
                                                                @foreach (var occupation in Model.JobOccupations)
                                                                {
                                                                    <option value="@occupation.Id">@occupation.Name</option>
                                                                }
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="errors alert alert-danger fade in" style="display: none;"></div>
                                            <div class="row">
                                                <p>
                                                    <div class="text-center">


                                                        <button class="btn green btn-sm padding-lf-15">保存</button>
                                                        <button type="button" class="btn yellow btn-sm padding-lf-15" data-dismiss="modal">返回</button>
                                                    </div>
                                                </p>
                                            </div>
                                            <!-- END FORM-->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts{
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src=@Url.Content("~/assets/global/plugins/moment.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/clockface/js/clockface.js") type="text/javascript"></script>
    <!-- END PAGE LEVEL PLUGINS -->
    <!-- BEGIN THEME GLOBAL SCRIPTS -->
    <script src=@Url.Content("~/assets/global/scripts/app.min.js") type="text/javascript"></script>
    <!-- END THEME GLOBAL SCRIPTS -->

    <script type="text/javascript">
        var funcs = {
            getProjectIds: function() {
                var ids = [];
                var checkboxes = $(".checkboxes");
                $.each(checkboxes, function(i, item) {
                    var chk = $(item);
                    if (chk.is(":checked")) {
                        var id = chk.val();

                        ids.push(id);
                    }
                });

                return ids;
            },
            updateButtons: function() {
                var checked = $(".checkboxes:checked").length > 0;
                var buttons = $(".batch-button");
                buttons.prop("disabled", !checked);
                if (checked) {
                    buttons.removeClass("disabled");
                } else {
                    buttons.addClass("disabled");
                }
            }
        };

        $(document).ready(function() {
            $(document).on("click", ".workflow-contract-edit", function() {
                var $this = $(this);
                var projectId = $this.attr('data-id');
                var workflowCategory = $this.attr('data-category');
                App.dialog('#workflow-contract-edit-form', '@Url.Action("EditWorkflowContract", "Project")' + "?projectId=" + projectId + "&workflowCategory=" + workflowCategory);
            });

            $(document).on("click", ".workflow-employee-edit", function() {
                var $this = $(this);
                var projectId = $this.attr('data-id');
                var workflowCategory = $this.attr('data-category');
                App.dialog('#workflow-employee-edit-form', '@Url.Action("EditWorkflowEmployee", "Project")' + "?projectId=" + projectId + "&workflowCategory=" + workflowCategory);
            });

            //user-Configure-edit
            $(document).on("click", ".user-Configure-edit", function () {
                var $this = $(this);
                var projectId = $this.attr('data-id');
                var category = $this.attr('data-category');
                App.dialog('#user-Configure-edit-form', '@Url.Action("Configure", "Project")' + "?projectId=" + projectId + "&configureCategory=" + category);
            });

            $(".group-checkable").change(function() {
                var checkAll = $(this);
                var checked = checkAll.is(":checked");
                checkAll.closest(".table").find(".checkboxes").prop("checked", checked).uniform("refresh");
                funcs.updateButtons();
            });

            $(".checkboxes").change(function() {
                funcs.updateButtons();
            });

            $("#valid").click(function() {
                var ids = funcs.getProjectIds();

                var url = '@Url.Action("ValidProjects", "Project")';
                var command = {
                    ProjectIds: ids
                };
                postCommand(url, command);
                return false;
            });

            $("#invalid").click(function() {
                var ids = funcs.getProjectIds();

                var url = '@Url.Action("InValidProjects", "Project")';
                var command = {
                    ProjectIds: ids
                };
                postCommand(url, command);
                return false;
            });

            $('.addProjectOccupation').click(function () {
                var $this = $(this);
                var projectid = $this.attr('data-projectid');
                var projectName = $this.attr('data-projectname');
                $('#projectIdToConfig').val(projectid);
                $('#addProjectName').text(projectName);
                var configProjectOccupation = $('#configProjectOccupation');
                configProjectOccupation.modal('show');
                configProjectOccupation.find("form").attr("action", "@Url.Action("CreateHRProjectJobOccupation", "Project")");
                clearFormValues("configProjectOccupation");
            });
        });
    </script>
}

