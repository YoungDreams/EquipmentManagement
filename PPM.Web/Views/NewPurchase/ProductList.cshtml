@using PensionInsurance.Query
@using PensionInsurance.Entities
@using PensionInsurance.Shared
@using PensionInsurance.Web.Common
@model PensionInsurance.Web.Views.NewPurchase.ProductListViewModel
<style>
    #productlist td {
        line-height: 45px;
    }

    #productlist td {
        text-align: center;
    }

    #productlist th {
        text-align: center;
    }
</style>
@section Breadcrumb{
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <a href="@Url.Action("Index","Home")">首页</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                采购管理
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <span>采购商品</span>
            </li>
        </ul>
    </div>
}
<!-- END PAGE BAR -->
<div class="row">
    <div class="col-md-12">
        <div class="portlet">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-gift"></i>商品查询
                </div>
            </div>
            <div class="portlet-body form">
                <!-- BEGIN FORM-->
                <form action="@Url.Action("ProductList", "NewPurchase")" class="form-horizontal">
                    <div class="form-body">
                        <div class="row">
                            @Html.HiddenFor(m => m.Query.ProjectId)
                            @Html.HiddenFor(m => m.Query.IsFood)
                            @Html.HiddenFor(m => m.CartId)
                            @Html.HiddenFor(m => m.ReturnUrl)
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-3">名称</label>
                                    <div class="col-md-9">
                                        <input type="text" autocomplete="off" class="form-control" data-provide="typeahead" data-items="5" id="QueryName" name="Query.Name" value="@Model.Query.Name" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-3">商品分类</label>
                                    <div class="col-md-9">

                                        <div class="input-group">
                                            <input type="text" class="form-control" disabled id="productCategoryText" value="@Model.CategoryText" placeholder="选择分类">
                                            <input id="productCategoryId" type="hidden" name="Query.ProductCategoryId" value="@Model.Query.ProductCategoryId" />
                                            <span id="getCategories" class="input-group-addon" style="padding: 3px 12px;">
                                                <i class="fa fa-bars"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-3">供应商</label>
                                    <div class="col-md-9">
                                        <select name="Query.ProductSupplierId" class="form-control input-small">
                                            <option value="">--未选择--</option>
                                            @foreach (var item in Model.Suppliers)
                                            {
                                                if (Model.Query.ProductSupplierId != null)
                                                {
                                                    if (item.Value == Model.Query.ProductSupplierId.ToString())
                                                    {
                                            <option value="@item.Value" selected="selected">@item.Text</option>
                                                    }
                                                    else
                                                    {
                                            <option value="@item.Value">@item.Text</option>
                                                    }
                                                }
                                                else
                                                {
                                            <option value="@item.Value">@item.Text</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--/row-->
                    </div>
                    <div class="form-actions">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-offset-5">
                                        <button type="submit" class="btn green">查询</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6"> </div>
                        </div>
                    </div>
                </form>
                <!-- END FORM-->
            </div>
        </div>
    </div>
</div>
<div class="row margin-top-10">
    <div class="col-md-12">
        <div class="portlet light bordered" style="height: auto;">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-social-dribbble font-green"></i>
                    <span class="caption-subject font-green bold uppercase">商品列表</span>
                </div>
                <div class="actions">
                    <div class="top-cart-block">
                        <div class="top-cart-info">
                            <a id="totalAmount" href="javascript:;" class="top-cart-info-count">
                                @Model.TotalAmount
                            </a>
                        </div>
                        <i class="fa fa-shopping-cart"></i>

                        <div class="top-cart-content-wrapper">
                            <div class="top-cart-content">
                                <div class="scroller" style="height: 250px;">
                                    <ul id="cartItems">

                                        @if (Model.CartItems.Any())
                                        {
                                            foreach (var item in Model.CartItems)
                                            {
                                                <li>
                                                    <strong><a href="JavaScript:;">@item.Name</a></strong>
                                                    <span class="cart-content-count">@item.Quantity</span><em>x</em><em>@item.Price</em>
                                                </li>
                                            }
                                        }
                                    </ul>
                                </div>
                                <div class="text-right">
                                    <a id="backurl" href="@(Model.ReturnUrl??Url.Action("Edit","PurchaseShoppingCart", new {id=Model.CartId}))" class="btn green">查看</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="portlet-body">
                <div class="table">
                    <table id="productlist" class="table table-striped table-bordered table-hover">
                        <thead>
                            <tr>
                                <th> 序号 </th>
                                <th> 商品名称 </th>
                                <th> 供应商名称 </th>
                                <th> 品牌 </th>
                                <th> 规格 </th>
                                <th> 单位 </th>
                                <th style="width: 120px;"> 采购数量 </th>
                                <th> 单价(元) </th>
                                <th> 描述 </th>
                                @if (!WebAppContext.Current.User.Department.Name.Contains("餐饮部"))
                                {
                                    <th> 库存数量 </th>
                                }
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Items.Any())
                            {
                                foreach (var item in Model.Items)
                                {
                                    <tr>
                                        <td>@Model.Items.RowNumberOf(item)</td>
                                        @if (string.IsNullOrEmpty(item.ThumbnailPath))
                                        {
                                        <td style="text-align: left;"> <img src="@Url.Content("~/assets/layouts/layout/img/noimg.jpg")" class="avatar" title="暂无图片" alt="暂无图片">@($"{item.Name}-{item.Code}")</td>
                                        }
                                        else
                                        {
                                            <td style="text-align: left;">
                                                <a href="@Url.Content(item.OriginalPath)" target="_blank">
                                                    <img class="avatar" src="@Url.Content(item.ThumbnailPath)" alt="">
                                                </a>@($"{item.Name}-{item.Code}")
                                            </td>
                                        }
                                        <td>@item.SupplierName</td>
                                        <td>@item.Brand</td>
                                        <td class="tooltips" data-container="body" data-placement="top" data-original-title="@item.Specification">@item.Specification.SubString(10, "...")</td>
                                        <td>@item.Unit</td>
                                        <td>
                                            <div class="input-group bootstrap-touchspin input-group-xs">
                                                <input type="text" id="touchspin_@item.PruductSupplierPriceId" value="@item.MinCount" min="@item.MinCount" max="@item.MaxCount" class="form-control touchspin col-xs-2 text-center">
                                            </div>
                                        </td>
                                        <td>@item.PriceFormatString</td>
                                        <td class="tooltips center" data-container="body" data-placement="top" data-original-title="@item.Description">@item.Description.SubString(15, "...")</td>
                                        @if (!WebAppContext.Current.User.Department.Name.Contains("餐饮部"))
                                        {
                                            <td class="tooltips" data-container="body" data-placement="top" data-original-title="@item.StockDesc">@item.StockSum</td>
                                        }
                                        <td>
                                            <a href="javascript:;" data-id="@item.PruductSupplierPriceId" class="btn btn-circle btn-icon-only green purchaseProduct">
                                                <i class="fa fa-shopping-cart"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr style="text-align: center;"><td colspan="11" style="text-align: center;">暂无商品</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            @Html.Partial("_Pagination", Model.Items)
        </div>
    </div>
</div>
<div class="modal small fade" id="productCategories" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width:600px;">
        <div class="modal-content">
            <div class="modal-body">
                <div class="portlet box green">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-gift"></i>商品分类
                        </div>
                    </div>
                    <div class="portlet-body">
                        <!-- BEGIN FORM-->
                        <div id="tree_1" class="tree-demo">
                            @Html.Raw(Model.ProductCategoryTreeView.GetSubTreeNodes(Model.ProductCategoryTreeView.Trees))
                        </div>
                        <div id="category-noselect-error" class="alert alert-danger hidden">
                            <strong>未选择商品分类!</strong>
                        </div>
                        <div class="row">
                            <br />
                            <p>
                                <div class="text-center">
                                    <button id="select-product-category" class="btn green btn-sm padding-lf-15">确定</button>
                                    <button id="cancel-select-product-category" type="button" class="btn yellow btn-sm padding-lf-15" data-dismiss="modal">取消</button>
                                </div>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts{
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-touchspin/bootstrap.touchspin.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-typeahead.js") type="text/javascript"></script>
    <script type="text/javascript">
        $(document).ready(function () {

            var returnUrl = $("#ReturnUrl").val();
            var back = '@Url.Action("Edit","PurchaseShoppingCart",new {id=Model.CartId})';
            if (returnUrl == null || returnUrl == "") {
                $("#backurl").attr("href", back);
            } else {
                $("#backurl").attr("href", returnUrl);
            }

            var queryKeyWords = $("#QueryName");
            queryKeyWords.typeahead({
                ajax: {
                    url: '@Url.Action("GetProducts", "NewPurchase")',
                    timeout: 300, // 延时
                    method: 'post',
                    triggerLength: 1, // 输入几个字符之后，开始请求
                    loadingClass: null, // 加载数据时, 元素使用的样式类

                    preDispatch: function (query) {
                        var para = { keyword: queryKeyWords.val() };
                        para.query = query;
                        return para;
                    },
                    preProcess: function (result) {

                        return result;
                    }
                },
                display: "Name", // 默认的对象属性名称为 name 属性
                items: 10, // 最多显示项目数量
                itemSelected: function (item, val, text) { // 当选中一个项目的时候，回调函数
                    var num = text.indexOf("-");
                    var str = text.substr(0, num);
                    $("#QueryName").val(str);
                }
            });
            
            //$(".touchspin").TouchSpin({
            //    min: 1,
            //    max: 100000,
            //    step: 1,
            //    decimals: 0,
            //    buttondown_class: "btn btn-xs",
            //    buttonup_class: "btn btn-xs"
            //});

            var touchspins = $(".touchspin");
            for (var i = 0; i < touchspins.length; i++) {
                var touchspin = touchspins[i];
                var max = parseFloat($(touchspin).attr('max'));
                var min = parseFloat($(touchspin).attr('min'));
                if (max == 0) {
                    max = 10000;
                }
                if (min == 0) {
                    min = 1;
                }
                $(touchspin).TouchSpin({
                    min: min,
                    max: max,
                    step: 1,
                    decimals: 0,
                    buttondown_class: "btn btn-xs",
                    buttonup_class: "btn btn-xs"
                });
            }

            $('#getCategories').on('click',
                function () {
                    var productCategories = $('#productCategories');
                    productCategories.modal('show');
                });

            $('#select-product-category').on('click',
                function () {
                    var checkedCategory = $('.jstree-clicked');
                    var categoryId = checkedCategory.attr('data-id');
                    var categoryText = checkedCategory.attr('data-text');
                    var error = $('#category-noselect-error');
                    if (categoryId || categoryText) {
                        error.addClass('hidden');
                        $('#productCategoryId').val(categoryId);
                        $('#productCategoryText').val(categoryText);

                        $('#cancel-select-product-category').click();
                    } else {
                        error.removeClass('hidden');
                    }
                });

            $("#ConfirmAdd").click(function () {
                var ids = funcs.getUserIds();
                var returnUrl = $("#ReturnUrl").val();
                var url = '@Url.Action("CreateCartItem", "NewPurchase")';
                var command = {
                    CartId: '@Model.CartId',
                    PruductSupplierPriceIds: ids,
                    ReturnUrl: returnUrl
                };
                postCommand(url, command);
                return false;
            });

            $(".purchaseProduct").click(function () {
                var infoBody = "";
                var $this = $(this);
                var id = $this.attr("data-id");
                var itemTotal = $("#touchspin_" + id);
                var quantity = itemTotal.val();
                if (parseFloat(quantity) < 0) {
                    quantity.val(1);
                    return false;
                }
                $.post("@Url.Action("AddCart", "NewPurchase")" + "?pruductSupplierPriceId=" + id + "&cartId=" + @Model.CartId +"&quantity=" + quantity,
                    function (e) {
                        if (e.success) {
                            $("#totalAmount").html(e.TotalAmount);
                            $("#cartItems").empty();
                            $.each(e.Items,
                                function(idx, data) {
                                    infoBody += bindData(data);
                                });
                            $("#cartItems").append(infoBody);
                        } else {
                            $.bootstrapGrowl("操作失败!\n"+e.msg, {
                                type: "danger",
                                offset: {
                                    from: "top",
                                    amount: 150
                                },
                                align: "center"
                            });
                        }
                    });
                return false;
            });

            function bindData(data) {
                var html = "";
                html += "<li>";
                html += "<strong><a href=\"javascript:void(0);\">" + data.Name + "</a></strong>";
                html += "<span class=\"cart-content-count\">" + data.Quantity + "</span><em>x</em><em>" + data.Price + "</em>";
                html += "</li>";
                return html;
            }
        });
    </script>
}