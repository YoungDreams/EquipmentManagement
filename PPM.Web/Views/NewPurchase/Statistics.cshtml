@using PensionInsurance.Entities
@using PensionInsurance.Shared
@using PensionInsurance.Web.Common
@model PensionInsurance.Web.Views.NewPurchase.StatisticsViewModel
@section Styles{
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-select/css/bootstrap-select.min.css") rel="stylesheet" type="text/css" />
    <style type="text/css">
        .select2-selection__rendered {
            height: 28px !important;
        }

        .select2-selection__choice {
            margin-top: 0px !important;
        }

        .select2-selection--multiple {
            height: 22px !important;
            min-height: 22px !important;
        }

        .select2-container--classic {
            width: 100% !important;
        }
    </style>
}
<!-- BEGIN PAGE BAR -->
@section Breadcrumb{
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <a href="@Url.Action("Index","Home")">首页</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <a href="@Url.Action("Index", "Purchase")">采购管理</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <span>采购统计分析</span>
            </li>
        </ul>
    </div>
}
<!-- END PAGE BAR -->
<div class="row">
    <div class="col-md-12">
        <div class="portlet">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-gift"></i>采购统计分析
                </div>
            </div>
            <div class="portlet-body form">
                <!-- BEGIN FORM-->
                <form action="@Url.Action("Statistics", "NewPurchase")" class="form-horizontal">
                    <div class="form-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-2">项目</label>
                                    <div class="col-md-9">
                                        @Html.DropDownListFor(x => x.Query.ProjectIds, Model.ProjectList, new { multiple = "", @class = "selectpicker" })
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-2">部门</label>
                                    <div class="col-md-9">
                                        @Html.DropDownListFor(x => x.Query.DepartmentIds, Model.DepartmentList, new { multiple = "", @class = "selectpicker" })
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-2">时间</label>
                                    <div class="col-md-10">
                                        <div class="input-group date-picker input-daterange" data-date="2016-05-05" data-date-format="yyyy-mm-dd">
                                            @Html.InputText(m => m.Query.StartTime)
                                            <span class="input-group-addon"> 到 </span>
                                            @Html.InputText(m => m.Query.EndTime)
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-2">分类</label>
                                    <div class="col-md-9">
                                        <div class="input-group">
                                            <input type="text" class="form-control" disabled id="productCategoryText" value="@Model.CategoryText" placeholder="选择分类">
                                            <input id="productCategoryId" type="hidden" name="Query.ProductCategoryIds" value="@Model.Query.ProductCategoryIds" />
                                            <span id="getCategories" class="input-group-addon" style="padding: 3px 12px;">
                                                <i class="fa fa-bars"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label class="control-label col-md-1">产品</label>
                                    <div class="col-md-11">
                                        <div class="row">
                                            <div class="col-md-12">
                                                @Html.DropDownListFor(x => x.Query.ProductIds, Model.ProductList, new {multiple = "", @class = "form-control"})
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--/span-->
                        </div>
                        <!--/row-->
                    </div>
                    <div class="form-actions">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-offset-5">
                                        <button type="submit" class="btn green">查询</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6"> </div>
                        </div>
                    </div>
                </form>
                <!-- END FORM-->
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="portlet light bordered" style="height: auto;">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-social-dribbble font-green"></i>
                    <span class="caption-subject font-green bold uppercase">统计分析</span>
                </div>
            </div>
            <div class="portlet-body">

                <table class="table-report table table-bordered">
                    <thead>
                        @if (!Model.Result.StatisticsOrderItems.Any())
                        {
                            <tr><th>暂无数据</th></tr>
                        }
                        else
                        {
                            <tr>
                                <th rowspan="2"></th>
                                <th></th>
                                <th></th>
                                @foreach (var project in Model.Result.ProjectNames)
                                {
                                    <th colspan="3">@project</th>
                                }
                            </tr>
                            <tr>
                                <th>产品类别</th>
                                <th>明细</th>
                                @foreach (var project in Model.Result.ProjectNames)
                                {
                                    <th>购买数量</th>
                                    <th>金额</th>
                                    <th>库存剩余数量</th>
                                }
                            </tr>
                        }
                    </thead>
                    <tbody>
                        @foreach (var department in Model.Result.DepartmentNames)
                        {
                            int num = 1;
                            int rows = Model.GetDepartmentRows(department);
                            var categoryName = "";
                            int productTypeRow = 0;
                            var newCategoryFirstRow = true;
                            foreach (var item in Model.Result.StatisticsOrderItems.Where(x => x.DepartmentName == department))
                            {
                                <tr>
                                    @{if (num == 1)
                                        {
                                            <td rowspan="@(rows)">@item.DepartmentName</td>
                                        }
                                        if (categoryName == "")
                                        {
                                            categoryName = item.CategoryName;
                                            productTypeRow = Model.Result.StatisticsOrderItems.Where(x => x.CategoryName == categoryName && x.DepartmentName == department).Count();
                                            newCategoryFirstRow = true;

                                        }
                                        else if (categoryName != item.CategoryName)
                                        {
                                            categoryName = item.CategoryName;
                                            productTypeRow = Model.Result.StatisticsOrderItems.Where(x => x.CategoryName == categoryName && x.DepartmentName == department).Count();
                                            newCategoryFirstRow = true;
                                        }
                                    }
                                    @if (newCategoryFirstRow)
                                    {
                                        <td rowspan="@(productTypeRow)">@item.CategoryName</td>
                                    }
                                    <a class="hide">@(newCategoryFirstRow = false)</a>
                                    <td>@item.ProductName<span>(@item.Specification)</span><span>(@item.Unit)</span></td>
                                    @foreach (var project in item.Projects)
                                    {
                                        <td>@project.Quantity</td>
                                        <td>@project.Amount</td>
                                        <td>@project.Stock</td>
                                    }
                                </tr>
                                <a class="hide">@(num++)</a>

                            }
                        }
                        <tr>
                            <td colspan="3">合计</td>
                            @foreach (var item in Model.Result.ProjectNames)
                            {
                                <td colspan="2">@Model.GetProjectpurchaseTotalAmount(item).TotalAmount</td>
                                <td>@Model.GetProjectpurchaseTotalAmount(item).TotalStockAmount</td>
                            }
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal small fade" id="productCategories" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width:600px;">
        <div class="modal-content">
            <div class="modal-body">
                <div class="portlet box green">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-gift"></i>商品分类
                        </div>
                    </div>
                    <div class="portlet-body">
                        <!-- BEGIN FORM-->
                        <div id="tree_2" class="tree-demo">
                            @Html.Raw(Model.ProductCategoryTreeView.GetSubTreeNodes(Model.ProductCategoryTreeView.Trees))
                        </div>
                        <div id="category-noselect-error" class="alert alert-danger hidden">
                            <strong>未选择商品分类!</strong>
                        </div>
                        <div class="row">
                            <br />
                            <p>
                                <div class="text-center">
                                    <button id="select-product-category" class="btn green btn-sm padding-lf-15">确定</button>
                                    <button id="cancel-select-product-category" type="button" class="btn yellow btn-sm padding-lf-15" data-dismiss="modal">取消</button>
                                </div>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts{
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-select/js/bootstrap-select.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/moment.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/scripts/app.min.js") type="text/javascript"></script>
    <script>
        var selectIds = [];
        var selectText = [];
        $(document).ready(function() {

            $('#getCategories').on('click',
                function() {
                    var productCategories = $('#productCategories');
                    productCategories.modal('show');
                });


            $('#tree_2').on('changed.jstree',
                function (e, data) {
                    var nodeId = data.node.id;
                    Object.keys(data.selected).map(function (item, i) {
                        var valElement = $('#' + data.selected[item]).attr('aria-labelledby');
                        $("#" + nodeId).jstree("open_node", $("#" + valElement));
                    });
                    selectIds = [];
                    selectText = [];
                    Object.keys(data.selected).map(function(item, i) {
                        var valElement = $('#' + data.selected[item]).attr('aria-labelledby');
                        selectIds.push($('#' + valElement).attr('data-id'));
                        selectText.push($('#' + valElement).attr('data-text'));
                    });
                    //console.log(selectIds);
                    //console.log(selectText);
                });

            $("#select-product-category").on("click",
                function() {
                    $("#productCategoryId").val(selectIds.join(","));
                    $("#productCategoryText").val(selectText.join(","));
                    var productCategories = $('#productCategories');
                    productCategories.modal('hide');
                });


            $('.selectpicker').selectpicker({
                style: 'btn-xs',
                iconBase: 'fa',
                tickIcon: 'fa-check',
                noneSelectedText: "--未选择--"
            });
            $("select[name='Query.ProjectIds']").val(@Html.Raw(Json.Encode(Model.Query.ProjectIds)));
            $("select[name='Query.DepartmentIds']").val(@Html.Raw(Json.Encode(Model.Query.DepartmentIds)));
            $("select[name='Query.ProductIds']").val(@Html.Raw(Json.Encode(Model.Query.ProductIds)));
            $("select[name='Query.ProductIds']").select2({
                theme: "classic",
                language: "zh-CN",
            });

            $("select[name='Query.ProductIds']").val(@Html.Raw(Json.Encode(Model.Query.ProductIds))).trigger('change');
            $('.selectpicker').selectpicker('refresh');
        });
    </script>
}