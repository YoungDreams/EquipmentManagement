@using PensionInsurance.Entities
@using Foundation.Core
@using PensionInsurance.Shared
@using PensionInsurance.Web.Common
@using PensionInsurance.Web.Views.HealthManagement
@model PensionInsurance.Web.Views.HealthManagement.HealthMonitoringViewModel
@section Styles{
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <link href=@Url.Content("~/assets/global/plugins/layui/css/layui.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/clockface/css/clockface.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/select2/css/select2.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/select2/css/select2-bootstrap.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/jstree/dist/themes/default/style.min.css") rel="stylesheet" type="text/css" />
    <!-- END PAGE LEVEL PLUGINS -->
}
<!-- BEGIN PAGE BAR -->
@section Breadcrumb{
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <a href="@Url.Action("Index", "HealthManagement")">健康体检首页</a>
                <i class="fa fa-circle"></i>
            </li>
            @if (Model.CheckStatus == "-1")
            {
                <li>
                    <a href="@Url.Action("MoreCustomerHealthIndex", "HealthManagement")">退住客户健康体检管理</a>
                    <i class="fa fa-circle"></i>
                </li>
            }
            <li>
                <span>健康报告</span>
            </li>
        </ul>
    </div>
}
<!-- END PAGE BAR -->
<div class="row margin-top-10">
    <div style="float:left; width:180px;">
        @Html.Partial("_LeftMenuInfo", Model)
    </div>
    <div style="float:left;width:calc(100% - 210px);">
        <div class="form-body">
            @Html.Partial("_CustomerBasicInfo", Model)
        </div>

        <div class="row margin-top-10">
            <div class="col-md-12">
                <div class="tabbable-custom">
                    <ul class="nav nav-tabs">
                        <li class="">
                            <a data-showloading="true" href="@Url.Action("HealthMonitoringIndex", "HealthManagement", new {customerAccountId = Model.CustomerInfo.CustomerAccountId,healthStatus=Model.HealthReportStatus})"> 健康检测指标 </a>
                        </li>
                        <li class="">
                            <a data-showloading="true" href="@Url.Action("Index", "GraphicReport",new {customerAccountId = Model.CustomerInfo.CustomerAccountId,healthStatus=Model.HealthReportStatus})"> 图文报告 </a>
                        </li>
                        <li class="active">
                            <a data-showloading="true" href="@Url.Action("HealthManageReport", "HealthManagement", new {customerAccountId = Model.CustomerInfo.CustomerAccountId,healthStatus=Model.HealthReportStatus})"> 健康报告 </a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="row margin-top-10">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-4" style="margin-top:6px;">显示日期：</label>
                                    <div class="col-md-8;">
                                        <select id="HReportDate" name="HReportDate" style="width:150px" class="form-control input-xs" onchange="gradeChange()">
                                            @if (Model.HealthReportStatus == 2)
                                            {
                                                <option value="">最近一次</option>
                                                for (int i = 0; i < Model.HMReportList.Count; i++)
                                                {
                                                    var hmrModel = Model.HMReportList[i];
                                                    <option value="@hmrModel.Id">@hmrModel.HReportDate.ToString("yyyy-MM-dd")</option>
                                                }
                                            }
                                            else
                                            {
                                                if (Model.HMReportList.Count == 0)
                                                {
                                                    <option value="">最近一次</option>
                                                }
                                                else
                                                {
                                                    for (int i = 0; i < Model.HMReportList.Count; i++)
                                                    {
                                                        var hmrModel = Model.HMReportList[i];
                                                        if (i == 0)
                                                        {
                                                            <option value="@hmrModel.Id">最近一次</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@hmrModel.Id">@hmrModel.HReportDate.ToString("yyyy-MM-dd")</option>
                                                        }
                                                    }
                                                }
                                            }


                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label id="lblHReportDate" class="control-label col-md-4" style="margin-top:6px;">报告时间：</label>
                                    <div class="col-md-8" style="margin-top:6px;">
                                        <div id="divHMRDate"></div>
                                        @*<label id="labHMRDate">--</label>*@
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row margin-top-15">
                            <label class="control-label col-md-3">&nbsp;健康报告：</label>
                        </div>
                        <div class="row margin-top-10" style="margin-left:5px;margin-right:5px;">
                            <textarea title="请编辑健康报告" class="form-control" style="height:150px;
                                    border-left: 1px solid #c2cad8;border-right: 1px solid #c2cad8;"
                                      id="txtHReport" name="txtHReport"></textarea>
                        </div>
                        <div class="row margin-top-10">
                            <label class="control-label col-md-3">&nbsp;健康指导意见：</label>
                        </div>
                        <div class="row margin-top-10" style="margin-left:5px;margin-right:5px;">
                            <textarea title="请编辑健康指导意见" class="form-control" style="height:150px;border-left: 1px solid #c2cad8;border-right: 1px solid #c2cad8;" id="txtHGuidance" name="txtHGuidance"></textarea>
                        </div>

                    </div>
                    <div id="diverrorManage" style="display:none" class="errors alert alert-danger fade in"></div>
                    <div class="form-actions margin-top-10">
                        <div class="text-right">
                            <input type="hidden" name="txthrId" id="txthrId" value="" />
                            <input type="hidden" name="txtLastId" id="txtLastId" value="" />
                            @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.健康管理, Permission.编辑健康报告) && Model.HealthReportStatus != 0)
                            {
                                <button id="EditHReport" type="button" class="btn yellow btn-sm padding-lf-15" onclick="EditHealthReportById();">修改</button>
                                <button id="DeleteHReport" type="button" class="btn yellow btn-sm padding-lf-15" style="margin-left:15px" onclick="DeleteHealthReportById();">删除</button>
                                <button id="SubmitHReport" type="button" class="btn green" onclick="SaveHealthReport()">提交</button>
                                <button id="SaveHReport" type="button" class="btn green" onclick="SaveHealthReport()">保存</button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js") type="text/javascript"></script>
    <!-- END PAGE LEVEL PLUGINS -->
    <script src=@Url.Content("~/assets/global/plugins/moment.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/clockface/js/clockface.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/scripts/app.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/select2/js/select2.full.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/select2/js/i18n/zh-CN.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/layui/layui.all.js") type="text/javascript"></script>
    <script type="text/javascript">


        /**************************************时间格式化处理************************************/
        function dateFtt(fmt, date) { //author: meizz
            var o = {
                "M+": date.getMonth() + 1,                 //月份
                "d+": date.getDate(),                    //日
                "h+": date.getHours(),                   //小时
                "m+": date.getMinutes(),                 //分
                "s+": date.getSeconds(),                 //秒
                "q+": Math.floor((date.getMonth() + 3) / 3), //季度
                "S": date.getMilliseconds()             //毫秒
            };
            if (/(y+)/.test(fmt))
                fmt = fmt.replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt))
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        }



        function SaveHealthReport() {
            var hrId = $("#txthrId").val();
            var hreport = $("#txtHReport").val();
            var hguidance = $("#txtHGuidance").val();
            var status = @Html.Raw(Model.HealthReportStatus);
            var errorManage = "";
            if (hreport == "" || hreport == "undefined") {
                errorManage += "健康报告不能为空!";
            }
            if (hguidance == "" || hguidance == " undefined") {
                errorManage += "健康指导意见不能为空!";
            }
            if (errorManage != "") {
                $("#diverrorManage").show();
                $("#diverrorManage").html(errorManage);
                return;
            }
            $("#diverrorManage").hide();
            var customerId = @Html.Raw(Model.CustomerInfo.CustomerId);
            if (hrId == "") {
                status = 1;
            }
            $.post("@Url.Action("SaveHealthReport", "HealthManagement")", { Id: hrId,CustomerId: customerId, HReport: hreport, HGuidance: hguidance },
                function (result) {
                    layer.msg('健康报告保存成功!');
                    setTimeout("LocationPage(" + status+")", 1000);

                });
        }
        function LocationPage(status) {
            var customerAccountId = @Html.Raw(Model.CustomerInfo.CustomerAccountId);
            location.href = "HealthManageReport?customerAccountId=" + customerAccountId + "&healthStatus=" + status;
        }
        //选择日期加载事件
        function gradeChange() {
            var objS = document.getElementById("HReportDate");
            var hrId = objS.options[objS.selectedIndex].value;
            var hrDate = objS.options[objS.selectedIndex].text;
            var customerId = @Html.Raw(Model.CustomerInfo.CustomerId);
            var status = @Html.Raw(Model.HealthReportStatus);
            var editStatus = @Model.EditStatus;
            $("#txthrId").val(hrId);
            //status(2去评估，1去查看，0退住查看)
            //editStatus 1，从健康监测首页编辑健康报告进入
            //if (editStatus == 1) {
            //    GetHealthReportById(hrId);
            //    if (hrDate == "最近一次") {
            //        $("#EditHReport").css("display", "none");
            //        $("#DeleteHReport").css("display", "none");
            //        $("#SubmitHReport").css("display", "none");

            //        $("#SaveHReport").css("display", "");
            //        $("#txtHReport").removeAttr("disabled");
            //        $("#txtHGuidance").removeAttr("disabled");
            //        $("#lblHReportDate").html("编辑时间：");
            //        var oDate = new Date(); //实例一个时间对象；
            //        var year = oDate.getFullYear();   //获取系统的年；计算，所以要加1
            //        var day = oDate.getDate(); // 获取系统日
            //        var month = oDate.getMonth() + 1;   //获取系统月份，由于月份是从0开始
            //        $("#divHMRDate").html(year + "-" + month + "-" + day);
            //    }
            //    else {
            //        $("#EditHReport").css("display", "none");
            //        $("#DeleteHReport").css("display", "none");
            //        $("#SaveHReport").css("display", "none");
            //        $("#txtHReport").attr("disabled", "disabled");
            //        $("#txtHGuidance").attr("disabled", "disabled");
            //    }
            //}
            //else {
            //有评估报告

                if (hrId != "") {
                    GetHealthReportById(hrId);
                    //状态为去评估时
                    if (status == 2) {
                        $("#lblHReportDate").html("报告时间：");
                        $("#EditHReport").css("display", "none");
                        $("#DeleteHReport").css("display", "none");
                        $("#SaveHReport").css("display", "none");
                        if (hrDate == "最近一次") {
                            $("#SubmitHReport").css("display", "");
                        } else {
                            $("#SubmitHReport").css("display", "none");
                        }
                    }// 当状态是去查看（1） 或状态是既有评估和查看时，点击查看（3）  显示编辑和删除
                    else if (status == 1 ) {
                        $("#EditHReport").css("display", "");
                        $("#DeleteHReport").css("display", "");
                        $("#SaveHReport").css("display", "none");
                        $("#SubmitHReport").css("display", "none");
                    }//当状态是0（退住查看时）隐藏编辑删除提交按钮
                    else if (status == 0) {
                        $("#EditHReport").css("display", "none");
                        $("#DeleteHReport").css("display", "none");
                        $("#SaveHReport").css("display", "none");
                        $("#SubmitHReport").css("display", "none");
                    }
                    $("#txtHReport").attr("disabled", "disabled");
                    $("#txtHGuidance").attr("disabled", "disabled");
                }//无评估报告
                else {
                    //状态不为0（推住用户）时 显示健康报告和健康指导意见
                    if (status == 1 || status == 0 ) {
                        $("#EditHReport").css("display", "none");
                        $("#DeleteHReport").css("display", "none");
                        $("#SaveHReport").css("display", "none");
                        $("#SubmitHReport").css("display", "none");
                    }

                    if (status == 2) {
                        $("#EditHReport").css("display", "none");
                        $("#DeleteHReport").css("display", "none");
                        $("#SaveHReport").css("display", "none");
                        $("#SubmitHReport").css("display", "");
                        $("#txtHReport").removeAttr("disabled");
                        $("#txtHGuidance").removeAttr("disabled");
                    }

                    GetHealthReportByCustomerId(customerId);
                    $("#lblHReportDate").html("编辑时间：");
                    var oDate = new Date(); //实例一个时间对象；
                    //var year = oDate.getFullYear();   //获取系统的年；计算，所以要加1
                    //var day = oDate.getDate(); // 获取系统日
                    //var month = oDate.getMonth() + 1;   //获取系统月份，由于月份是从0开始
                    //var hmrDate = year + "-" + month + "-" + day;
                    //$("#divHMRDate").html(hmrDate);

                    $("#divHMRDate").html(dateFtt("yyyy年MM月dd日 hh:mm", oDate));

                }//状态为2隐藏删除和编辑按钮
                //if (status == 2) {
                //    $("#EditHReport").css("display", "none");
                //    $("#DeleteHReport").css("display", "none");
                //}
           // }
        }
        //初始加载
        $(document).ready(function () {
            gradeChange();

        });

        // 根据客户编号和报告日期找健康报告
        function GetHealthReportById(hrId) {
            $.get("@Url.Action("GetHealthReportById", "HealthManagement")" + "?Id=" + hrId,
                function (result) {
                    $.each(result, function (idx, data) {
                        if (idx == "HReportDate") {
                            if (data != "") {
                                $("#divHMRDate").html(data);
                            }

                        }
                        else if (idx == "HReport") {
                            $("#txtHReport").val(data);
                        }
                        else if (idx == "HGuidance") {
                            $("#txtHGuidance").val(data);
                        }
                    });
                });
        }
        // 根据客户编号和报告日期找健康报告
        function GetHealthReportByCustomerId(CustomerId) {
            $.get("@Url.Action("GetHealthReportByCustomerId", "HealthManagement")" + "?CustomerId=" + CustomerId,
                function (result) {
                    $.each(result, function (idx, data) {
                        if (idx == "HReport") {
                            $("#txtHReport").val(data);
                        }
                        else if (idx == "HGuidance") {
                            $("#txtHGuidance").val(data);
                        }
                    });
                });
        }
        //根据健康报告编号删除健康报告并更新评估状态
        function DeleteHealthReportById() {
            var hrId = $("#txthrId").val();
            layer.confirm('您确定删除当前信息?', function (index) {
                layer.close(index);
                var customerId = @Html.Raw(Model.CustomerInfo.CustomerId);
                $.post("@Url.Action("DeleteHealthReportById", "HealthManagement")" + "?Id=" + hrId + "&customerId=" + customerId,
                    function (result) {
                        LocationPage(1);
                });
            });
        }
        //编辑健康报告
        function EditHealthReportById() {
            layer.confirm('您确定修改当前信息?', function (index) {
                $("#txtHReport").removeAttr("disabled");
                $("#txtHGuidance").removeAttr("disabled");
                $("#EditHReport").css("display", "none");
                $("#DeleteHReport").css("display", "none");
                $("#SaveHReport").css("display", "");
                $("#SubmitHReport").css("display", "none");
                $("#lblHReportDate").html("编辑时间：");
                var oDate = new Date(); //实例一个时间对象；
                //var year= oDate.getFullYear();   //获取系统的年；计算，所以要加1
                //var day =oDate.getDate(); // 获取系统日
                //var month =oDate.getMonth() + 1;   //获取系统月份，由于月份是从0开始
                //$("#divHMRDate").html(year + "-" + month + "-" + day);

                $("#divHMRDate").html(dateFtt("yyyy年MM月dd日 hh:mm", oDate));

                layer.close(index);

            });
        }
    </script>
}
