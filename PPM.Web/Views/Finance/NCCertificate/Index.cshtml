@using PensionInsurance.Entities
@using PensionInsurance.Query
@using PensionInsurance.Shared
@using PensionInsurance.Web.Common;
@model PensionInsurance.Web.Views.Finance.NCCertificate.IndexViewModel
@section Styles{
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/clockface/css/clockface.css") rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/assets/global/plugins/datatables/datatables.min.css")" rel="stylesheet" type="text/css" />
}
@section Breadcrumb{
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <a href="@Url.Action("Index", "Home")">首页</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <span>NC凭证管理</span>
            </li>
        </ul>
    </div>
}
<div class="row">
    <div class="col-md-12">
        <div class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-social-dribbble font-green"></i>
                    <span class="caption-subject font-green-sharp bold uppercase">NC凭证信息列表</span>
                </div>
                
                <div class="actions">
                    @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.NC凭证管理, Permission.生成客户月账单凭证))
                    {
                        <a data-type="@NCCertificateType.月费结转收入" href="javascript:;" class="btn green nc-certificate-generate">
                            <i class="fa fa-certificate"></i> 生成客户月账单凭证
                        </a>
                    }
                    @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.NC凭证管理, Permission.生成客户一次性安置费账单凭证))
                    {
                        <a data-type="@NCCertificateType.一次性安置费结转收入" href="javascript:;" class="btn green nc-certificate-generate">
                            <i class="fa fa-certificate"></i> 生成客户一次性安置费账单凭证
                        </a>
                    }
                    @*@if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.NC凭证管理, Permission.生成客户现金流水凭证))
                    {
                        <a data-toggle="modal" href="#generateNCCertificateModal" class="btn green">
                            <i class="fa fa-certificate"></i> 生成客户现金流水凭证
                        </a>
                    }*@
                </div>
            </div>
            <div class="portlet-body">
                <div class="table-toolbar">
                    <div class="row">
                        <div class="col-md-6">
                        </div>
                    </div>
                </div>
                <div class="table">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>记账公司编码</th>
                                <th>凭证类型</th>
                                <th>会计年度</th>
                                <th>会计区间</th>
                                <th>创建时间</th>
                                <th>是否导入</th>
                                <th>同步结果</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var item in Model.NCCertificates)
                        {
                            <tr>
                                <td>@item.CompanyCode</td>
                                <td>@item.NCCertificateType.ToString()</td>
                                <td>@item.FiscalYear</td>
                                <td>@item.AccountingPeriod</td>
                                <td>@item.CreatedOn.DateTimeString()</td>
                                <td>@(item.IsSync? "已导入" : "未导入")</td>
                                <td class="tooltips" data-container="body" data-placement="left" data-original-title="@item.SyncResult">@item.SyncResult.SubString(20, "...")</td>
                                <td>
                                    @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.NC凭证管理, Permission.查看))
                                    {
                                        <a class="btn default btn-xs yellow-stripe" href="@Url.Action("Entries", "NCCertificate", new {ncCertificateId = item.Id})">查看明细</a>
                                    }
                                    @if (!item.IsSync && PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.NC凭证管理, Permission.导入))
                                    {
                                        <a href="javascript:;" data-command="@Model.ImportCommand(item.Id).ToJavascript()" class="btn default btn-xs blue-stripe">导入NC</a>
                                    }
                                    @if (!item.IsSync && PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.NC凭证管理, Permission.删除))
                                    {
                                        <a href="javascript:;" data-command="@Model.DeleteCommand(item.Id).ToJavascript()" class="btn default btn-xs red-stripe">删除</a>
                                    }
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>

                </div>
                @Html.Partial("_Pagination", Model.NCCertificates)
            </div>
        </div>
    </div>
</div>

@*<div class="modal small fade" id="generate-nc-certificate-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 400px;">
        <form id="generate-nc-certificate-form" data-ajax="true" action="#" method="POST" class="form-horizontal">

            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">生成客户月账单凭证</h4>
                </div>

                <div class="modal-body">

                    <!-- BEGIN FORM-->
                    <div class="form-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="control-label col-md-3">项目</label>
                                    <div class="col-md-9">
                                        @Html.DropDownList("ProjectId", Model.ProjectList, new { @class = "form-control" })
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="control-label col-md-3">账单月份</label>
                                    <div class="col-md-9">
                                        <input name="NCCertificateMonth" class="input-sm month-picker" data-opts='{"endDate":"@DateTime.Now.AddMonths(-2).ToShortDateString()"}'/>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="control-label col-md-3">制单日期</label>
                                    <div class="col-md-9">
                                        <input name="PreparedDate" class="input-sm date-picker" value="@DateTime.Now.ToString("yyyy-MM-dd")" data-date-format="yyyy-mm-dd"/>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="errors alert alert-danger fade in" style="display: none;"></div>
                        <div class="row">
                            <p>
                                <div class="text-center">
                                    <a id="generate-nc-certificate" href="javascript:;" class="btn green btn-sm padding-lf-15">生成</a>
                                    <button type="button" class="btn yellow btn-sm padding-lf-15" data-dismiss="modal">返回</button>
                                </div>
                            </p>
                        </div>
                        <!-- END FORM-->
                    </div>
                </div>

            </div>
        </form>
    </div>
</div>*@

@section Scripts{
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-select/js/bootstrap-select.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/moment.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/scripts/app.min.js") type="text/javascript"></script>
    <script type="text/javascript">

        $(document).ready(function () {
            $(document)
                .on("click",
                    ".nc-certificate-generate",
                    function () {
                        var $this = $(this);
                        var type = $this.attr("data-type");
                        var url = '@Url.Action("Generate", "NCCertificate")'+'?type=' + type;
                        App.dialog('#nc-certificate-generate-form', url);
                    });
        });
        @*$(document).ready(function () {
            $(document).on("click", ".generate-nc-certificate", function () {
                var form = $("#generate-nc-certificate-form");

                var ncCertificateMonth = form.find("input[name='NCCertificateMonth']");
                var projectId = form.find("select[name='ProjectId']");
                var preparedDate = form.find("input[name='PreparedDate']");

                var command = {
                    NCCertificateMonth: ncCertificateMonth.val(),
                    ProjectId: projectId.val(),
                    PreparedDate: preparedDate.val()
                };

                $("#generateNCCertificateModal").modal("hide");

                form.postCommand('@Url.Action("GenerateNCCertificate", "Bill")', command, {
                    onSuccess: function () {
                        window.location.reload();
                        return false;
                    },
                    onFail: function (result) {
                        $.bootstrapGrowl(result.errors, {
                            type: "warning",
                            offset: {
                                from: "top",
                                amount: 150
                            },
                            align: "center"
                        });
                    }
                });

                return false;
            });
        });*@
    </script>
}