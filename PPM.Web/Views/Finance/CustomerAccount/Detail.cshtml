@using PensionInsurance.Entities
@using PensionInsurance.Shared
@using PensionInsurance.Web.Common
@using PensionInsurance.Query
@model PensionInsurance.Web.Views.Finance.CustomerAccount.IndexViewModel
@section Styles{
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/clockface/css/clockface.css") rel="stylesheet" type="text/css" />
    <!-- END PAGE LEVEL PLUGINS -->
}
<!-- BEGIN PAGE BAR -->
@section Breadcrumb{
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <a href="@Url.Action("Index", "Home")">首页</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <a href="@Url.Action("Index", "CustomerAccount")">客户账户管理</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <span>账户信息</span>
            </li>
        </ul>
    </div>
}
<!-- END PAGE BAR -->
<div class="row">
<div class="tabbable-custom nav-justified">
    <ul class="nav nav-tabs nav-justified">
        <li class="active">
            <a data-toggle="tab" href="#tabPayment" aria-expanded="true">现金信息</a>
        </li>
        <li class="">
            <a data-toggle="tab" href="#tabPoint" aria-expanded="false">积分信息</a>
        </li>
    </ul>
    <div class="tab-content">
        <div id="tabPayment" class="tab-pane active">
            <!--金额信息-->
            <div class="row" style="margin-top: 10px;">
                <div class="col-md-12">
                    <div class="portlet light bordered">
                        <div class="portlet-title">
                            <div class="caption">
                                <i class="icon-social-dribbble font-green"></i>
                                <span class="caption-subject font-green bold uppercase">现金信息</span>
                            </div>
                        </div>
                        <div class="portlet-body">
                            <div class="table-scrollable">
                                <table id="tablePayment" class="table table-hover" data-src="@Request.Url">
                                    <thead>
                                    <tr>
                                        <th style="white-space: nowrap;">序号</th>
                                        <th style="white-space: nowrap;">项目</th>
                                        <th style="white-space: nowrap;">客户姓名</th>
                                        <th style="white-space: nowrap;">收支日期</th>
                                        <th style="white-space: nowrap;">到账日期</th>
                                        <th style="white-space: nowrap;">收支方式</th>
                                        <th style="white-space: nowrap;">收入金额</th>
                                        <th style="white-space: nowrap;">支出金额</th>
                                        @*<th style="white-space: nowrap;">实到金额</th>
                                            <th style="white-space: nowrap;">财务成本</th>*@
                                        <th style="white-space: nowrap;">备注</th>
                                        <th style="white-space: nowrap;">收支人</th>
                                        <th style="white-space: nowrap;">确认人</th>
                                        <th style="white-space: nowrap;">状态</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    @foreach (var item in Model.CustomerPaymentList)
                                    {
                                        <tr>
                                            <td>@Model.CustomerPaymentList.RowNumberOf(item)</td>
                                            <td style="white-space: nowrap;">@item.CustomerAccount.Project.Name</td>
                                            <td><a href="@Url.Action("Index", "CustomerAccount", new CustomerAccountQuery {Name = item.CustomerAccount.Customer.Name, CustomerNo = item.CustomerAccount.Customer.CustomerNo})">@item.CustomerAccount.Customer.Name</a></td>
                                            <td style="white-space: nowrap;">@item.PaymentDate.DateString()</td>
                                            <td style="white-space: nowrap;">@item.ActualArrivalDate.DateString()</td>
                                            <td>@item.PaymentType</td>
                                            @if (item.Payment > 0)
                                            {
                                                <td class="paymentcaption" data-id="@item.Id"><a href="javascript:;">@item.Payment</a></td>
                                                <td></td>
                                            }
                                            else
                                            {
                                                <td></td>
                                                <td>@item.Payment</td>
                                            }
                                            @*<td>@item.ActualPayment</td>
                                                <td>@item.RatePayment</td>*@
                                            <td>@item.Description</td>
                                            <td>@item.AgentName</td>
                                            <td>@item.FinancerName</td>
                                            <td style="white-space: nowrap;">@item.Status</td>
                                        </tr>
                                    }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="tabPoint" class="tab-pane">
            <!--积分信息-->
            <div class="row" style="margin-top: 10px;">
                <div class="col-md-12">
                    <div class="portlet light bordered">
                        <div class="portlet-title">
                            <div class="caption">
                                <i class="icon-social-dribbble font-green"></i>
                                <span class="caption-subject font-green bold uppercase">积分信息</span>
                            </div>
                            <div class="actions">
                                @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.客户积分管理, Permission.新增))
                                {
                                    <a href="javascript:;" class="btn green add-customer-point" role="button"><i class="fa fa-plus"></i>新增</a>
                                }
                            </div>
                        </div>
                        <div class="portlet-body">
                            <div class="table-scrollable">
                                <table id="tablePoint" class="table table-hover" data-src="@Request.Url">
                                    <thead>
                                    <tr>
                                        <th style="white-space: nowrap;">序号</th>
                                        <th style="white-space: nowrap;">项目</th>
                                        <th style="white-space: nowrap;">客户姓名</th>
                                        <th style="white-space: nowrap;">收支日期</th>
                                        <th style="white-space: nowrap;">使用方式</th>
                                        <th style="white-space: nowrap;">收入积分</th>
                                        <th style="white-space: nowrap;">支出积分</th>
                                        <th style="white-space: nowrap;">收支人</th>
                                        <th style="white-space: nowrap;">确认人</th>
                                        <th style="white-space: nowrap;">备注</th>
                                        <th style="white-space: nowrap;">状态</th>
                                        <th style="white-space: nowrap;">操作</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    @foreach (var item in Model.CustomerPointList)
                                    {
                                        <tr>
                                            <td>@Model.CustomerPointList.RowNumberOf(item)</td>
                                            <td style="white-space: nowrap;">@item.CustomerAccount.Project.Name</td>
                                            <td><a href="@Url.Action("Index", "CustomerAccount", new CustomerAccountQuery {Name = item.CustomerAccount.Customer.Name, CustomerNo = item.CustomerAccount.Customer.CustomerNo})">@item.CustomerAccount.Customer.Name</a></td>
                                            <td style="white-space: nowrap;">@item.UseDate.DateString()</td>
                                            <td>@item.PointType.ToString()</td>
                                            @if (item.UsePoint > 0)
                                            {
                                                <td>@item.UsePoint</td>
                                                <td></td>
                                            }
                                            else
                                            {
                                                <td></td>
                                                <td>@item.UsePoint</td>
                                            }
                                            <td>@item.AgentName</td>
                                            <td>@item.FinancerName</td>
                                            <td>@item.Remark</td>
                                            <td style="white-space: nowrap;">@item.Status</td>
                                            <td style="white-space: nowrap;">
                                                @if (item.Status != CustomerPointStatus.确认)
                                                {
                                                    if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.客户积分管理, Permission.编辑) && item.PointCategory != PointCategory.老带新)
                                                    {
                                                        <a href="javascript:;" data-src="@Url.Action("EditCustomerPoint", "CustomerAccount", new {id = item.Id})" class="btn default btn-xs yellow-stripe edit-customer-point">编辑</a>
                                                    }
                                                    if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.客户积分管理, Permission.删除))
                                                    {
                                                        <a href="javascript:;" data-command="@Model.DeletePoint(item.Id).ToJavascript()" class="btn default btn-xs red-stripe" data-refresh="#tablePoint">删除</a>
                                                    }
                                                    if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.客户积分管理, Permission.确认))
                                                    {
                                                        <a href="javascript:;" data-command="@Model.ConfirmPoint(item.Id).ToJavascript()" class="btn default btn-xs green-stripe" data-refresh="#tablePoint">确认</a>
                                                    }
                                                }
                                            </td>
                                        </tr>
                                    }
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="text-center">
        <div class="row" style="margin-top: 10px;">
            <a href="@Url.Action("Index", "CustomerAccount")" class="btn yellow btn-sm padding-lf-15">返回上一页</a>
        </div>
    </div>
</div>
    <div class="modal small fade" id="confirmPayment" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="width:500px;">
            <form data-ajax="true" action="#" method="POST" class="form-horizontal" data-refresh="#tablePayment">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="portlet box green">
                            <div class="portlet-title">
                                <div class="caption">
                                    <i class="fa fa-gift"></i>确认缴费信息
                                </div>
                            </div>
                            <div class="portlet-body form">
                                <!-- BEGIN FORM-->
                                <div class="form-body">
                                    <div class="row" style="margin-top: 5px;">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label class="text-right col-md-3">客户姓名</label>
                                                <div class="col-md-9">
                                                    <input type="text" class="form-control" name="CustomerName" readonly>
                                                    <input type="hidden" name="CustomerPaymentId"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label class="text-right col-md-3">收支方式</label>
                                                <div class="col-md-9">
                                                    <input type="text" class="form-control" name="PaymentTypeDesc" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label class="text-right col-md-3">收支金额</label>
                                                <div class="col-md-9">
                                                    <input type="text" class="form-control" name="Payment" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row" style="margin-top: 5px;">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label class="text-right col-md-3">实际到账日期</label>
                                                <div class="col-md-9">
                                                    <input type="text" class="form-control form-control-inline date-picker" name="ActualArrivalDate" data-date-format="yyyy-mm-dd">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="errors alert alert-danger fade in" style="display: none;"></div>
                                    <div class="row">
                                        <p>
                                            <div class="text-center">
                                                <button class="btn green btn-sm padding-lf-15">确认</button>
                                                <button type="button" class="btn yellow btn-sm padding-lf-15" data-dismiss="modal">取消</button>
                                            </div>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
@section Scripts{
    <script src=@Url.Content("~/assets/global/plugins/moment.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/clockface/js/clockface.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/scripts/app.min.js") type="text/javascript"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $(document)
               // 亲属信息
               .on("click", ".add-customer-point", function () {
                   App.dialog('#customer-point-create-form', '@Url.Action("CreatePoint", "CustomerAccount", new { customerAccountId = Model.CustomerAccountId })');
               })
               .on("click", ".edit-customer-point", function () {
                   var src = $(this).attr("data-src");
                   App.dialog('#customer-point-edit-form', src);
               });
            $(".paymentcaption").click(function() {
                var $this = $(this);
                var paymentId = $this.attr("data-id");
                $.get("@Url.Action("GetPaymentCaption", "CustomerAccount")" + "?id=" + paymentId,
                    function(result) {
                        App.alert({title:"收支详细信息", content: result });
                    });
            });
        });
        //确认缴费信息弹出窗
        function confirmPayment(customerPaymentId) {
            var confirmPaymentInfo = $('#confirmPayment');
            $.get("@Url.Action("EditCustomerPayment", "CustomerAccount")" + "/" + customerPaymentId, function (result) {
                confirmPaymentInfo.modal('show');
                confirmPaymentInfo.find("form").attr("action", "@Url.Action("SubmitCustomerPayment", "CustomerAccount", new { returnUrl = Request.Url })");
                setFormValues(result);
            });
        }
        // 确认积分信息
        function submitPoint(customerPointId) {
            var url = '@Url.Action("SubmitCustomerPoint", "CustomerAccount")';
            var command = {
                CustomerPointId: customerPointId,
                ReturnUrl: "@Request.Url"
            };
            postCommand(url, command);
            return false;
        }
    </script>
}