@using System.Web.Mvc.Html
@using PensionInsurance.Entities
@using PensionInsurance.Query
@using PensionInsurance.Shared
@using PensionInsurance.Web.Common
@model PensionInsurance.Web.Views.Finance.CustomerAccount.CustomerPaymentsViewModel
@section Styles{
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/clockface/css/clockface.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/select2/css/select2.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/select2/css/select2-bootstrap.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/jstree/dist/themes/default/style.min.css") rel="stylesheet" type="text/css" />
    <!-- END PAGE LEVEL PLUGINS -->
}
<!-- BEGIN PAGE BAR -->
@section Breadcrumb{
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <a href="@Url.Action("Index","Home")">首页</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <span>客户现金管理</span>
            </li>
        </ul>
    </div>
}
<div class="row">
    <div class="col-md-12" style="margin-top: 10px;">
        <div class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-social-dribbble font-green"></i>
                    <span class="caption-subject font-green bold uppercase">客户现金收入管理</span>
                </div>
                <div class="actions">
                    @if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.客户现金流水管理, Permission.客户现金流水批量确认))
                    {
                        <a data-toggle="modal" href="#MassConfirm" class="btn green btn-sm batch-button disabled">
                            <i class="fa fa-check"></i> 批量确认
                        </a>
                    }
                </div>
            </div>
            <div class="portlet-body">
                <div class="table">

                    <table id="tablePayment" class="table table-hover" data-src="@Request.Url">
                        <thead>
                        <tr>
                            <th>
                                <input type="checkbox" class="group-checkable" value=""/>
                            </th>
                            <th style="white-space: nowrap;">序号</th>
                            <th style="white-space: nowrap;">项目</th>
                            <th style="white-space: nowrap;">客户姓名</th>
                            <th style="white-space: nowrap;">收支日期</th>
                            <th style="white-space: nowrap;">收支方式</th>
                            <th style="white-space: nowrap;">收支金额</th>
                            <th style="white-space: nowrap;">备注</th>
                            <th style="white-space: nowrap;">发起人</th>
                            <th style="white-space: nowrap;">确认人</th>
                            <th style="white-space: nowrap;">状态</th>
                            <th style="white-space: nowrap;">操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        @{ string keyFlag = "";}
                        @foreach (var item in Model.CustomerPaymentList)
                        {
                            <tr>
                                <td>
                                    <input type="checkbox" class="checkboxes" value="@item.Id"/>
                                </td>
                                <td>@Model.CustomerPaymentList.RowNumberOf(item)</td>
                                <td style="white-space: nowrap;">@item.CustomerAccount.Project.Name</td>
                                <td><a href="@Url.Action("Index", "CustomerAccount", new CustomerAccountQuery {Name = item.CustomerAccount.Customer.Name, CustomerNo = item.CustomerAccount.Customer.CustomerNo})">@item.CustomerAccount.Customer.Name</a></td>
                                <td style="white-space: nowrap;">@item.PaymentDate.DateString()</td>
                                <td>@item.PaymentType</td>
                                @if (item.Payment > 0)
                                {
                                    <td class="paymentcaption" data-id="@item.Id"><a href="javascript:;">@item.Payment</a></td>
                                }
                                else
                                {
                                    <td>@item.Payment</td>
                                }
                                <td class="tooltips" data-container="body" data-placement="top" data-original-title="@item.Description">@item.Description.SubString(20, "...")</td>
                                <td>@item.AgentName</td>
                                <td>@item.FinancerName</td>
                                <td style="white-space: nowrap;">@item.Status</td>
                                <td style="white-space: nowrap;">
                                    @if (item.Status != CustomerPaymentStatus.确认)
                                    {
                                        if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.客户现金管理, Permission.删除) && item.PaymentCategory != PaymentCategory.退款)
                                        {
                                            <a href="javascript:;" data-command="@Model.DeletePayment(item.Id).ToJavascript()" class="btn default btn-xs red-stripe" data-refresh="#tablePayment">删除</a>
                                        }

                                        if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.客户现金管理, Permission.确认))
                                        {
                                            <a href="javascript:;" onclick="confirmPayment(@item.Id)" class="btn default btn-xs green-stripe" data-refresh="#tablePayment">确认</a>
                                        }
                                    }
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>

                    @Html.Partial("_Pagination", Model.CustomerPaymentList)
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal small fade" id="confirmPayment" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 500px;">
        <form data-ajax="true" action="#" method="POST" class="form-horizontal" data-refresh="#tablePayment">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="portlet box green">
                        <div class="portlet-title">
                            <div class="caption">
                                <i class="fa fa-gift"></i>确认缴费信息
                            </div>
                        </div>
                        <div class="portlet-body form">
                            <!-- BEGIN FORM-->
                            <div class="form-body">
                                <div class="row" style="margin-top: 5px;">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="text-right col-md-3">客户姓名</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control" name="CustomerName" readonly>
                                                <input type="hidden" name="CustomerPaymentId"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="text-right col-md-3">收支方式</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control" name="PaymentTypeDesc" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="text-right col-md-3">收支金额</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control" name="Payment" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row" style="margin-top: 5px;">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="text-right col-md-3">实际到账日期</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-inline date-picker" name="ActualArrivalDate" data-date-format="yyyy-mm-dd">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="errors alert alert-danger fade in" style="display: none;"></div>
                                <div class="row">
                                    <p>
                                        <div class="text-center">
                                            <button class="btn green btn-sm padding-lf-15">确认</button>
                                            <button type="button" class="btn yellow btn-sm padding-lf-15" data-dismiss="modal">取消</button>
                                        </div>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="modal small fade" id="MassConfirm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 450px;">
        <form id="confim-payment-form" data-ajax="true" action="#" method="POST" class="form-horizontal">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="portlet box green">
                        <div class="portlet-title">
                            <div class="caption">
                                <i class="fa fa-gift"></i>客户现金流水批量确认
                            </div>
                        </div>
                        <div class="portlet-body form">
                            <!-- BEGIN FORM-->
                            <div class="form-body">
                                <div class="row margin-top-20">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="control-label col-md-3">实际到账日期</label>
                                            <div class="col-md-9">
                                                <input type="text" class="input-sm date-picker form-control" name="ConfimDateTime" data-date-format="yyyy-mm-dd">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="errors alert alert-danger fade in" style="display: none;"></div>
                                <div class="row">
                                    <p>
                                        <div class="text-center">
                                            <a href="javascript:;" id="confim-payment" class="btn green btn-sm padding-lf-15">批量确认</a>
                                            <button type="button" class="btn yellow btn-sm padding-lf-15" data-dismiss="modal">返回</button>
                                        </div>
                                    </p>
                                </div>
                                <!-- END FORM-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
@section Scripts{
    <script src=@Url.Content("~/assets/global/plugins/moment.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/clockface/js/clockface.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/scripts/app.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/select2/js/select2.full.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/jstree/dist/jstree.min.js") type="text/javascript"></script>
    <script type="text/javascript">
        var page = {
            getSelectedIds: function() {
                var ids = [];
                var checkboxes = $(".checkboxes");
                $.each(checkboxes, function(i, item) {
                    var chk = $(item);
                    if (chk.is(":checked")) {
                        var id = chk.val();

                        ids.push(id);
                    }
                });

                return ids;
            },

            updateButtons: function() {
                var checked = $(".checkboxes:checked").length > 0;
                var buttons = $(".batch-button");
                buttons.prop("disabled", !checked);
                if (checked) {
                    buttons.removeClass("disabled");
                } else {
                    buttons.addClass("disabled");
                }
            }
        }

//确认缴费信息弹出窗
        function confirmPayment(customerPaymentId) {
            var confirmPaymentInfo = $('#confirmPayment');
            $.get("@Url.Action("EditCustomerPayment", "CustomerAccount")" + "/" + customerPaymentId, function(result) {
                confirmPaymentInfo.modal('show');
                confirmPaymentInfo.find("form").attr("action", "@Url.Action("SubmitCustomerPayment", "CustomerAccount", new {returnUrl = Request.Url})");
                setFormValues(result);
            });
        }

        $(document).ready(function() {
            $(document).on("change", ".group-checkable", function() {
                var checkAll = $(this);
                var checked = checkAll.is(":checked");
                checkAll.closest(".table").find(".checkboxes").prop("checked", checked).uniform("refresh");
                page.updateButtons();
            });
            $(".paymentcaption").click(function() {
                var $this = $(this);
                var paymentId = $this.attr("data-id");
                $.get("@Url.Action("GetPaymentCaption", "CustomerAccount")" + "?id=" + paymentId,
                    function(result) {
                        App.alert({title:"收支详细信息", content: result });
                    });
            });
            $(document).on("change", ".checkboxes", function() {
                page.updateButtons();
            });
            $(document).on("click", "#confim-payment", function () {
                var form = $("#confim-payment-form");

                var confimDateTime = form.find("input[name='ConfimDateTime']");
                var paymentIds = page.getSelectedIds();
                var command = {
                    ConfimDateTime: confimDateTime.val(),
                    PaymentIds: paymentIds
                };
                $("#MassConfirm").modal("hide");
                form.postCommand('@Url.Action("ConfirmPayments", "CustomerAccount")', command, {
                    onSuccess: function () {
                        return true;
                    },
                    onFail: function (result) {
                        $.bootstrapGrowl(result.errors, {
                            type: "warning",
                            offset: {
                                from: "top",
                                amount: 150
                            },
                            align: "center"
                        });
                    }
                });
            });
        });
    </script>
}
