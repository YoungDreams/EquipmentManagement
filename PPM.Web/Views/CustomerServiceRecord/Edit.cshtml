@using PensionInsurance.Commands
@using PensionInsurance.Entities
@using PensionInsurance.Web.Common
@model PensionInsurance.Web.Views.CustomerServiceRecord.EditViewModel
@section Styles{
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/clockface/css/clockface.css") rel="stylesheet" type="text/css" />

    <link href=@Url.Content("~/assets/global/plugins/select2/css/select2.min.css") rel="stylesheet" type="text/css" />
    <link href=@Url.Content("~/assets/global/plugins/select2/css/select2-bootstrap.min.css") rel="stylesheet" type="text/css" />
    <!-- END PAGE LEVEL PLUGINS -->
}

<!-- BEGIN PAGE BAR -->
@section Breadcrumb{
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <a href="@Url.Action("Index","Home")">首页</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <a href="@Url.Action("Detail","Customer",new {CustomerAccountId = Model.CustomerAccountId})">客户信息</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <span>点单编辑</span>
            </li>
        </ul>
    </div>
}
<div>
    <div class="full-height-content-body">
        <form id="menuForm" data-ajax="true" action="@Url.Action("Edit", "CustomerServiceRecord", new {returnUrl = Url.Action("IndexCheckIn", "Customer") })" method="POST" class="form-horizontal">
            <div class="portlet light bordered">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="icon-social-dribbble font-green"></i>
                        <span class="caption-subject font-green bold uppercase">点单信息</span>
                    </div>
                </div>
                <div class="portlet-body form">
                    <!-- BEGIN FORM-->
                    <div class="form-body">
                        <div class="row" style="margin-top: 2px;">
                            @Html.HiddenFor(m => m.Id)
                            @Html.HiddenFor(m => m.ProjectId)
                            @Html.HiddenFor(m => m.UnitPrice)
                            @Html.HiddenFor(m => m.CustomerId)
                            @Html.HiddenFor(m => m.CustomerAccountId)
                            @Html.HiddenFor(m => m.ConsumptiveMaterialList)
                            @Html.HiddenFor(m => m.ProjectServicePackCatalogId)
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label col-md-2">服务项目</label>
                                    <div class="col-md-10">
                                        <select id="ProjectServicePackCatalog" name="ProjectServicePackCatalog" class="form-control input-small select2">
                                            <option value="">--未选择--</option>
                                            @foreach (var catalog in Model.ProjectServicePackCatalogs)
                                            {
                                                if (catalog.Id == Model.ProjectServicePackCatalogId)
                                                {
                                                    <option value="@catalog.ToJavascript()" selected="selected" data-service-type="@catalog.Type.ToString()">@catalog.ServicePackCatalogNo @catalog.Name</option>
                                                }
                                                else
                                                {
                                                    <option value="@catalog.ToJavascript()" data-service-type="@catalog.Type.ToString()">@catalog.ServicePackCatalogNo @catalog.Name</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-top: 2px;">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label col-md-2">服务日期</label>
                                    <div class="col-md-10">
                                        <input type="text" id="ServiceDate" class="form-control form-control-inline date-picker" name="ServiceDate" value="@Model.ServiceDate.DateString()" data-date-format="yyyy-mm-dd" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label col-md-2">服务次数</label>
                                    <div class="col-md-10">
                                        <input type="text" class="form-control" id="ServiceAmount" name="ServiceAmount" value="@Model.ServiceAmount" onchange="changeValue();" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-top: 2px;">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label col-md-2">服务单价</label>
                                    <div class="col-md-10">
                                        <input type="text" class="form-control" id="UnitPriceDescription" name="UnitPriceDescription" value="@Model.UnitPriceRemark" readonly />
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label col-md-2">服务说明</label>
                                    <div class="col-md-10">
                                        <input type="text" class="form-control" id="ProjectServicePackCatalogRemark" name="ProjectServicePackCatalogRemark" value="@Model.ServiceRemark" readonly />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-top: 2px;">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label col-md-2">金额合计</label>
                                    <div class="col-md-10">
                                        <input type="text" class="form-control" id="Total" value="@Model.Total" name="Total" readonly />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-top: 2px;">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label col-md-2">备注</label>
                                    <div class="col-md-10">
                                        <textarea class="form-control" id="Remark" name="Remark" style="resize: none;">@Model.Remark</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row" style="margin-top: 10px;">
                            <div class="col-md-12">
                                <div class="portlet light bordered">
                                    <div class="portlet-title">
                                        <div class="caption">
                                            <i class="icon-social-dribbble font-green"></i>
                                            <span class="caption-subject font-green bold uppercase">耗材明细</span>
                                        </div>
                                        <div class="actions">
                                            <a id="consumptiveMaterialChoose" href="javascript:;" class="btn green btn-sm padding-lf-15" herf="">添加耗材</a>
                                        </div>
                                    </div>
                                    <div class="portlet-body">
                                        <div class="table">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th width="25%">耗材名称</th>
                                                        <th width="25%">单价</th>
                                                        <th width="25%">数量</th>
                                                        <th width="25%">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="consumptiveMaterialBody">
                                                    @if (Model.ConsumptiveMaterialServices.Any())
                                                    {
                                                        foreach (var item in Model.ConsumptiveMaterialServices)
                                                        {
                                                            <tr id="tr_@item.ConsumptiveMaterial.Id" data-id="@item.ConsumptiveMaterial.Id">
                                                                <td>@item.ConsumptiveMaterial.Name</td>
                                                                <td>@item.ConsumptiveMaterial.UnitPrice</td>
                                                                <td><input type="text" class="form-control" id="consumptiveNum_@item.ConsumptiveMaterial.Id" name="consumptiveNum" value="@item.Amount" onchange="consumptiveMaterialNum(@item.ConsumptiveMaterial.Id);"></td>
                                                                <td><a href="javascript:;" class="btn default btn-xs red-stripe" onclick="deleteItem(@item.ConsumptiveMaterial.Id);">删除</a></td>
                                                                <td><input type="hidden" class="form-control" id="consumptiveTotal_@item.ConsumptiveMaterial.Id" name="consumptiveTotal" value="@(item.Price*item.Amount)"></td>
                                                            </tr>
                                                        }
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="fromErrors" class="errors alert alert-danger fade in" style="display: none;"></div>
            <div class="form-actions">
                <div class="text-center">
                    <button type="submit" class="btn green btn-sm padding-lf-15 ">保存</button>
                    <a href="@Url.Action("Detail", "Customer",new {customerAccountId = Model.CustomerAccountId})" class="btn yellow btn-sm padding-lf-15">返回</a>
                </div>
            </div>
        </form>
    </div>

    <div class="modal small fade" id="consumptiveMaterialInfo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="width:600px;height:auto;">
            <div class="modal-content">
                <div class="modal-body">
                    <form data-ajax="true" action="#" method="POST" class="form-horizontal">
                        <div class="row" style="margin-top: 10px;">
                            <div class="col-md-12">
                                <div class="portlet-body form">
                                    <div class="form-body">
                                        <div class="portlet light bordered">
                                            <div class="portlet-title">
                                                <div class="caption">
                                                    <i class="icon-social-dribbble font-green"></i>
                                                    <span class="caption-subject font-green bold uppercase">耗材信息</span>
                                                </div>
                                            </div>
                                            <div class="portlet-body">
                                                <div id="consumptiveErrors" class="errors alert alert-danger fade in" style="display: none;"></div>
                                                <div class="row">
                                                    <div class="col-md-9">
                                                        <div class="form-group">
                                                            <label class="control-label col-md-4">耗材名称</label>
                                                            <div class="col-md-6">
                                                                <input type="text" class="form-control" id="KeyValue" name="KeyValue" oninput="getConsumptiveMaterial();" />
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="table">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>&nbsp;</th>
                                                                <th>耗材</th>
                                                                <th>价格</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="bodyInfo"></tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <p>
                                                <div class="text-center">
                                                    <button type="button" class="btn green btn-sm padding-lf-15" onclick="addConsumptiveMaterial();">添加</button>
                                                    <a href="@Url.Action("Detail", "Customer",new {customerAccountId = Model.CustomerAccountId})" class="btn yellow btn-sm padding-lf-15">返回</a>
                                                </div>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js") type="text/javascript"></script>
    <!-- END PAGE LEVEL PLUGINS -->
    <script src=@Url.Content("~/assets/global/plugins/moment.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/clockface/js/clockface.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/scripts/app.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/select2/js/select2.full.min.js") type="text/javascript"></script>
    <script type="text/javascript">
        var consumptiveMaterialList = {};   // 耗材信息列表
        var errors = $("#fromErrors");
        var serviceErrors = $("#serviceErrors");
        var consumptiveErrors = $("#consumptiveErrors");

        $(document).ready(function () {

            $("#consumptiveMaterialBody tr").each(function (idx, trConsumptiveMaterial) {
                var consumptiveMaterialId = $(trConsumptiveMaterial).attr("data-id");
                var consumptiveNum = $(trConsumptiveMaterial).find("#consumptiveNum_" + consumptiveMaterialId).val();
                consumptiveMaterialList[consumptiveMaterialId] = consumptiveNum;
            });

            $("#ConsumptiveMaterialList").val(JSON.stringify(consumptiveMaterialList));

            $(".select2").select2();
            $("#ProjectServicePackCatalog").on("change", function () {
                if ($(this).val()) {
                    var data = JSON.parse($(this).val());
                    $("#UnitPrice").val(data.UnitPrice ? data.UnitPrice : "");
                    $("#ServiceAmount").val(1);
                    var unitString = parseInt(data.UnitPrice).toString();
                    if (data.UnitPriceRemark.indexOf(unitString) === -1) {
                        $("#UnitPriceDescription").val(data.UnitPrice + '/' + data.UnitPriceRemark);
                    } else {
                        $("#UnitPriceDescription").val(data.UnitPriceRemark);
                    }
                    $("#ProjectServicePackCatalogRemark").val(data.Remark);
                    $("#ProjectServicePackCatalogId").val(data.Id);

                    if ($(this).val().indexOf("包月") > 0) {
                        $("#ServiceAmount").prop("readonly", "readonly");
                    } else {
                        $("#ServiceAmount").removeProp("readonly");
                    }

                } else {
                    $("#UnitPrice").val("");
                    $("#UnitPriceDescription").val("");
                    $("#ServiceAmount").val(1);
                    $("#ProjectServicePackCatalogRemark").val("");
                    $("#ProjectServicePackCatalogId").val("");
                }

                getTotal();
            });

        });

        $(document).ready(function () {
            // 选择服务项目
            $("#consumptiveMaterialChoose").click(function () {
                if ($("#ServiceCode").val() == "") {
                    errors.find("p").remove();
                    errors.hide();
                    errors.append("<p>请先选择服务</p>");
                    errors.show();
                } else {
                    consumptiveErrors.find("p").remove();
                    consumptiveErrors.hide();
                    errors.find("p").remove();
                    errors.hide();
                    $("#bodyInfo").empty();
                    var infoBody = "";
                    $.get("@Url.Action("GetConsumptiveMaterials", "CustomerServiceRecord")" + "?key=" + $("#KeyValue").val(),
                       function (result) {
                           $.each(result, function (idx, data) {
                               infoBody += getConsumptiveMaterialBody(data);
                           });
                           $("#bodyInfo").append(infoBody);
                       });
                    $('#consumptiveMaterialInfo').modal('show');
                }
            });
        });

        // 服务数量变化时，计算合计
        function changeValue() {
            var serviceAmount = $("#ServiceAmount").val();
            var unitPrice = $("#UnitPrice").val();
            if (unitPrice.length == 0) {
                errors.find("p").remove();
                errors.hide();
                errors.append("<p>请选择一个服务项目</p>");
                errors.show();
            } else {
                if (serviceAmount.length != 0) {
                    if (isNaN(serviceAmount)) {
                        errors.find("p").remove();
                        errors.hide();
                        errors.append("<p>请输入数字</p>");
                        errors.show();
                    } else {
                        if ($("#ProjectServicePackCatalog").val().indexOf("特别点单") <= 0) {
                            if (serviceAmount <= 0) {
                                errors.find("p").remove();
                                errors.hide();
                                errors.append("<p>输入的数字必须大于0</p>");
                                errors.show();
                            } else if (parseInt(serviceAmount) != serviceAmount) {
                                errors.find("p").remove();
                                errors.hide();
                                errors.append("<p>服务次数不能包含小数</p>");
                                errors.show();
                            } else {
                                errors.find("p").remove();
                                errors.hide();
                                if (!isNaN(unitPrice)) {
                                    getTotal();
                                }
                            }
                        } else {
                            if (serviceAmount < 0) {
                                errors.find("p").remove();
                                errors.hide();
                                errors.append("<p>服务次数不能为负数</p>");
                                errors.show();
                            } else {
                                errors.find("p").remove();
                                errors.hide();
                                if (!isNaN(unitPrice)) {
                                    getTotal();
                                }
                            }
                        }
                    }
                }
            }
        }

        // 合计计算
        function getTotal() {
            var unitPrice = $("#UnitPrice").val();  // 单价
            var serviceAmount = $("#ServiceAmount").val();  // 服务次数
            var objTr = $("input[name='consumptiveTotal']");

            var temp = 0;
            $.each(objTr, function (i, item) {
                var obj = $(item);
                temp = parseFloat(temp) + parseFloat(obj.val());
            });

            var total = (parseFloat(unitPrice) * parseFloat(serviceAmount) + parseFloat(temp)).toFixed(2);
            if (total) {
                $("#Total").val(total);
            } else {
                $("#Total").val(0);
            }


            var radio = $('input:radio[name="ServiceRecordType"]:checked').val();

            $("#ConsumptiveMaterialList").val(JSON.stringify(consumptiveMaterialList));
        }

        // 查询耗材信息
        function getConsumptiveMaterial() {
            $("#bodyInfo").empty();
            var infoBody = "";
            $.get("@Url.Action("GetConsumptiveMaterials", "CustomerServiceRecord")" + "?key=" + $("#KeyValue").val(),
               function (result) {
                   $.each(result, function (idx, data) {
                       infoBody += getConsumptiveMaterialBody(data);
                   });
                   $("#bodyInfo").append(infoBody);
               });
        }

        function getConsumptiveMaterialBody(data) {
            var infoBody = "";
            infoBody += "<tr id=" + data.Id + ">";
            infoBody += "<td>";
            infoBody += "<input type=\"checkbox\" name=\"consumptive\" class=\"group-checkable\" value=" + data.Id + " />";
            infoBody += "</td>";
            infoBody += "<td>";
            infoBody += data.Name;
            infoBody += "</td>";
            infoBody += "<td>";
            infoBody += data.UnitPrice;
            infoBody += "</td>";
            infoBody += "<td style=\"DISPLAY:none\">";
            infoBody += data.Id;
            infoBody += "</td>";
            infoBody += "</tr>";

            return infoBody;
        }

        // 选择耗材
        function addConsumptiveMaterial() {
            var radio = $('input:checkbox[name="consumptive"]:checked');
            if (radio.length > 0) {
                consumptiveErrors.find("p").remove();
                consumptiveErrors.hide();

                $(radio).each(function () {
                    var objTr = $("#" + $(this).val());

                    var infoBody = "";
                    var trid = "#tr_" + objTr.find('td').eq(3).text();
                    if ($(trid).length > 0) {
                        var temp = parseFloat($("#consumptiveNum_" + objTr.find('td').eq(3).text()).val()) + 1;
                        $("#consumptiveNum_" + objTr.find('td').eq(3).text()).val(temp);
                        consumptiveMaterialNum(objTr.find('td').eq(3).text());
                    }
                    else {
                        infoBody += "<tr id=\"tr_" + objTr.find('td').eq(3).text() + "\">";
                        infoBody += "<td>";
                        infoBody += objTr.find('td').eq(1).text();
                        infoBody += "</td>";
                        infoBody += "<td>";
                        infoBody += objTr.find('td').eq(2).text();
                        infoBody += "</td>";
                        infoBody += "<td><input type=\"text\" class=\"form-control\" id=\"consumptiveNum_" + objTr.find('td').eq(3).text() + "\" name=\"consumptiveNum\" value=\"1\" onchange=\"consumptiveMaterialNum(" + objTr.find('td').eq(3).text() + ");\" />";
                        infoBody += "</td>";
                        infoBody += "<td>";
                        infoBody += "<a href=\"javascript:;\" class=\"btn default btn-xs red-stripe\" onclick=\"deleteItem(" + objTr.find('td').eq(3).text() + ");\">删除</a>";
                        infoBody += "</td>";
                        infoBody += "<td><input type=\"hidden\" class=\"form-control\" id=\"consumptiveTotal_" + objTr.find('td').eq(3).text() + "\" name=\"consumptiveTotal\" value=\"" + parseFloat(objTr.find('td').eq(2).text()) + "\" />";
                        infoBody += "</td>";
                        infoBody += "</tr>";
                        $("#consumptiveMaterialBody").append(infoBody);
                        consumptiveMaterialList[objTr.find('td').eq(3).text()] = 1;
                    }


                });

                $('#consumptiveMaterialInfo').modal('hide');

                getTotal();
            } else {
                consumptiveErrors.find("p").remove();
                consumptiveErrors.hide();
                consumptiveErrors.append("<p>请选择一种耗材</p>");
                consumptiveErrors.show();
            }
        }

        // 耗材数量变化
        function consumptiveMaterialNum(id) {
            var num = $("#consumptiveNum_" + id).val();

            if (num.length != 0) {
                if (isNaN(num)) {
                    errors.find("p").remove();
                    errors.hide();
                    errors.append("<p>请输入数字</p>");
                    errors.show();
                } else {
                    if (num <= 0) {
                        errors.find("p").remove();
                        errors.hide();
                        errors.append("<p>输入的数字必须大于0</p>");
                        errors.show();
                    } else {
                        var objTr = $("#tr_" + id);
                        var temp = parseFloat(objTr.find('td').eq(1).text()) * num;
                        $("#consumptiveTotal_" + id).val(temp);
                        consumptiveMaterialList[id] = num;
                        getTotal();
                        errors.find("p").remove();
                        errors.hide();
                    }
                }
            }
        }

        // 删除耗材
        function deleteItem(id) {
            var trid = "tr_" + id;
            $("#" + trid).remove();
            delete consumptiveMaterialList[id];
            getTotal();
        }
    </script>
}
