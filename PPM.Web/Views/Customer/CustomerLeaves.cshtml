@using PensionInsurance.Entities
@using PensionInsurance.Shared
@using PensionInsurance.Web.Common
@model PensionInsurance.Web.Views.Customer.CustomerLeavesViewModel
@section Breadcrumb{
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <a href="@Url.Action("Index","Home")">首页</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <a href="@Url.Action("Index","Customer")">客户管理</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <span>客户请假信息</span>
            </li>
        </ul>
    </div>
}
<div class="row">
    <div class="col-md-12">
        <div class="portlet">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-gift"></i>客户请假信息查询
                </div>
            </div>
            <div class="portlet-body form">
                <!-- BEGIN FORM-->
                <form action="@Url.Action("CustomerLeaves", "Customer")" class="form-horizontal">
                    <div class="form-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-3">项目</label>
                                    <div class="col-md-9">
                                        <select name="Query.ProjectId" class="form-control input-xs">
                                            @if (WebAppContext.Current.User.GetAllowedProjects().Count > 1)
                                            {
                                                <option value="">全部</option>
                                            }

                                            @foreach (var project in WebAppContext.Current.User.GetAllowedProjects())
                                            {
                                                <option value="@project.Id" @(project.Id == Model.Query.ProjectId ? "selected" : "")>@project.Name</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-3">客户姓名</label>
                                    <div class="col-md-9">
                                        @Html.InputText(m => m.Query.CustomerName)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <div class="text-center">

                            <button type="submit" class="btn green btn-sm padding-lf-15 ">查询</button>

                        </div>
                    </div>
                </form>
                <!-- END FORM-->
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-social-dribbble font-green"></i>
                    <span class="caption-subject font-green bold uppercase">请假信息</span>
                </div>
            </div>
            <div class="portlet-body">
                <div class="table-scrollable">
                    <table id="leave-items" class="table table-hover">
                        <thead>
                            <tr>
                                <th>序号</th>
                                <th>项目名称</th>
                                <th>客户编号</th>
                                <th>客户姓名</th>
                                <th>开始时间</th>
                                <th>结束时间</th>
                                <th>请假原因</th>
                                <th>销假时间</th>
                                <th>离开天数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.CustomerWithoutList)
                            {
                                <tr>
                                    <td>@Model.CustomerWithoutList.RowNumberOf(item)</td>
                                    <td>@item.CustomerAccount.Project.Name</td>
                                    <td>@item.CustomerAccount.Customer.CustomerNo</td>
                                    <td>@item.CustomerAccount.Customer.Name</td>
                                    <td style="white-space: nowrap;">@item.StartTime.DateTimeString()</td>
                                    <td style="white-space: nowrap;">@item.EndTime.DateTimeString()</td>
                                    <td>@item.Reason.SubString(20, "...")</td>
                                    <td style="white-space: nowrap;">@(item.ResumptionTime?.DateTimeString())</td>
                                    <td>@item.LeaveAmount</td>
                                    <td>
                                        <div class="btn-group">
                                            @if (item.ResumptionTime == null)
                                            {
                                                if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.客户请假, Permission.客户销假))
                                                {
                                                    <a href="javascript:;" onclick="backLeave(@item.Id)" class="btn default btn-xs yellow-stripe">销假</a>
                                                }

                                                if (PensionInsurance.Shared.WebAppContext.Current.User.HasPermission(ModuleType.客户请假, Permission.删除))
                                                {
                                                    <a href="javascript:;" data-command="@Model.DeleteCommand(item.Id).ToJavascript()" class="btn default btn-xs red-stripe" data-refresh="#leave-items">
                                                        删除
                                                    </a>
                                                }
                                            }
                                        </div>
                                    </td>

                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal small fade" id="backLeave" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 400px;">
        <form data-ajax="true" action="#" method="POST" class="form-horizontal" data-refresh="#leave-items">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="portlet box green">
                        <div class="portlet-title">
                            <div class="caption">
                                <i class="fa fa-gift"></i>销假
                            </div>
                        </div>
                        <div class="portlet-body form">
                            <!-- BEGIN FORM-->
                            <div class="form-body">
                                <div class="row" style="margin-top: 5px;">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="text-right col-md-3">销假时间</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-inline" id="ResumptionTime" name="ResumptionTime" data-date-format="yyyy-mm-dd hh:ii">
                                            </div>
                                            <input type="hidden" id="CustomerLeaveId" name="CustomerLeaveId" />
                                        </div>
                                    </div>
                                </div>
                                <div class="errors alert alert-danger fade in" style="display: none;"></div>
                                <div class="row">
                                    <p>
                                        <div class="text-center">
                                            <button class="btn green btn-sm padding-lf-15">保存</button>
                                            <button type="button" class="btn yellow btn-sm padding-lf-15" data-dismiss="modal">返回</button>
                                        </div>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
@section Scripts{
    <script src=@Url.Content("~/assets/global/plugins/moment.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/clockface/js/clockface.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/scripts/app.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/select2/js/select2.full.min.js") type="text/javascript"></script>
    <script src=@Url.Content("~/assets/global/plugins/jstree/dist/jstree.min.js") type="text/javascript"></script>
    <script type="text/javascript">
        if (jQuery) {
            $('.date-picker').datepicker({
                rtl: App.isRTL(),
                orientation: "left",
                autoclose: true
            });
            $('.timepicker').timepicker({
                minuteStep: 5,
                showMeridian: false
            });
            $('#ResumptionTime').datetimepicker({
                autoclose: true,
                todayBtn: true,
                language: "zh-CN"
            });
        }
        // 销假
        function backLeave(customerLeaveId) {
            $("#CustomerLeaveId").val(customerLeaveId);
            var backLeave = $('#backLeave');
            backLeave.modal('show');
            backLeave.find("form").attr("action", "@Url.Action("BackCustomerLeave", "Customer", new {returnUrl = Request.Url})");
            clearFormValues("backLeave");
        }
    </script>
}


