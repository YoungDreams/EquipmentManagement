@using PensionInsurance.Entities
@using PensionInsurance.Shared
@using PensionInsurance.Query
@using PensionInsurance.Web.Common
@model PensionInsurance.Web.Views.Purchase.Collecting.CollectingProductViewModel
<!-- BEGIN PAGE BAR -->
@section Breadcrumb{
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <a href="@Url.Action("Index","Home")">首页</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <a href="@Url.Action("Index", "Purchase")">采购管理</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <span>出库单</span>
            </li>
        </ul>
    </div>
}
<!-- END PAGE BAR -->
<div class="row">
    <div class="col-md-12">
        <div class="portlet" style="margin-top: 10px;">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-gift"></i>出库信息
                </div>
            </div>
            <div class="portlet-body form">
                <!-- BEGIN FORM-->
                <form action="@Url.Action("CollectingProductStock","Collecting",new {page = Model.Items.Page,pageSize = Model.Items.PageSize})" class="form-horizontal">
                    <div class="form-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="control-label col-md-3">项目:</label>
                                    <div class="col-md-9">
                                        @Model.Query.ProjectName
                                        <input type="hidden" class="form-control" name="Query.ProjectId" value="@Model.Query.ProjectId" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="control-label col-md-3">申请部门</label>
                                    <div class="col-md-9">
                                        @Model.DepartmentName
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="control-label col-md-3">申请人</label>
                                    <div class="col-md-9">
                                        @Model.UserName
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="control-label col-md-3">申请日期</label>
                                    <div class="col-md-9">
                                        <input type="text" class="form-control" id="CollectingDate" name="CollectingDate" value="@Model.CollectingDate" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--/row-->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label col-md-2">领用单：</label>
                                    <div class="control-label col-md-10">
                                        @*@if (!string.IsNullOrWhiteSpace(Model.ConfirmPaperFilePathList[0]))
                                        {
                                            <a id="displayFile" href="@Url.Content(Model.ConfirmPaperFilePathList[0])" target="_blank">@Model.ConfirmPaperFilePathList[0]</a>
                                            <a id="uploadShow" href="javascript:;" class="col-md-3 padding-lf-15">重新上传</a>
                                        }
                                        else
                                        {*@
                                            <a id="displayFile" href="javascript:;" target="_blank"></a>
                                            <a id="uploadShow" href="javascript:;" class="col-md-3 padding-lf-15">上传领用单</a>
                                        @*}*@
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <!-- END FORM-->
            </div>
        </div>
    </div>
</div>
<div class="row margin-top-10">
    <div class="col-md-12">
        <form id="collectingProducts" action="#" method="POST" data-ajax="true" data-refresh="#collectingProductlist" class="form-horizontal">
            <div class="portlet light bordered" style="height: auto;">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="icon-social-dribbble font-green"></i>
                        <span class="caption-subject font-green bold uppercase">出库明细</span>
                    </div>
                    <div class="actions pull-right">
                        @if (WebAppContext.Current.User.HasPermission(ModuleType.出库, Permission.新增))
                        {
                            <a href="@Url.Action("SelectProductToCollect", "Collecting", new { ProjectId = Model.Query.ProjectId })" class="btn green">
                                <i class="fa " aria-hidden="true"></i>
                                选择商品出库
                            </a>
                        }
                        @if (WebAppContext.Current.User.HasPermission(ModuleType.出库, Permission.查看))
                        {
                            <a href="@Url.Action("CollectingProduct", "Collecting", new { ProjectId = Model.Query.ProjectId })" class="btn green">
                                <i class="fa " aria-hidden="true"></i>
                                出库记录
                            </a>
                        }
                    </div>
                </div>
                <input type="hidden" name="CollectingDate" id="collecting-date-to-submit" value="" />
                <input type="hidden" name="ProjectId" value="@Model.Query.ProjectId" />
                <div class="portlet-body">
                    <div class="table">
                        <table id="collectingProductlist" class="table table-hover table-scrollable">
                            <thead>
                            <tr>
                                <th> 序号 </th>
                                <th> 出库商品名 </th>
                                <th> 品牌 </th>
                                <th> 规格 </th>
                                <th> 单位 </th>
                                <th> 单价(元) </th>
                                <th> 出库数量 </th>
                                <th> 库存 </th>
                                <th> 资产类别 </th>
                                <th> 备注及用途 </th>
                                <th> 领取人 </th>
                                <th> 操作 </th>
                            </tr>
                            </thead>
                            <tbody>
                            @if (Model.Items.Any())
                            {
                                var index = 0;
                                foreach (var item in Model.Items)
                                {
                                    var product = item.Product;
                                    var price = item.PurchaseProductStock?.PurchaseProductSupplier?.Price;
                                    <tr>
                                        <td>
                                            @Model.Items.RowNumberOf(item)
                                            <input type="hidden" name="CollectingItems[@index].Id" value="@item.Id" />
                                        </td>
                                        <td>@product.Name</td>
                                        @*<td>@supplier.Name</td>*@
                                        <td>@product.Brand</td>
                                        <td>@product.Specification</td>
                                        <td>@product.Unit</td>
                                        <td>@(price?.FormatString())</td>
                                        <td><input type="text" name="CollectingItems[@index].CollectingQuantity" class="form-control moveOutStockQuantity" id="collectingQuantity" value="@item.CollectingQuantity" style="resize: none;" onkeyup="this.value = this.value.replace(/[^\d]/g, '')" onafterpaste="this.value = this.value.replace(/[^\d]/g, '')" /></td>
                                        <td>@(item.PurchaseProductStock?.Stock)</td>
                                        <td>@product.AssetClass</td>
                                        <td><input type="text" name="CollectingItems[@index].Remark" class="form-control" value="@item.Remark" /></td>
                                        <td><input type="text" name="CollectingItems[@index].Collector" class="form-control" value="@item.Collector" /></td>
                                        <td><a href="javascript:;" data-command="@Model.DeleteCommand(item.Id, Request.Url.ToString()).ToJavascript()" class="btn default btn-xs red-stripe">删除</a></td>
                                    </tr>
                                    index++;
                                }
                            }
                            else
                            {
                                <tr><td colspan="11" style="text-align: center;">暂无商品</td></tr>
                            }
                            </tbody>
                        </table>
                    </div>
                    <input type="hidden" id="fileName" name="fileName"/>
                    <div class="errors alert alert-danger fade in" style="display: none;"></div>
                    <div class="form-actions">
                        <div class="text-center">
                            <a id="ConfirmAdd" href="javascript:;" class="btn green batch-button">
                                提交
                            </a>
                            <a id="" href="@Url.Action("CollectingProduct", "Collecting", new { ProjectId = Model.Query.ProjectId })" class="btn btn-warning batch-button">
                                取消
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal small fade" id="uploadInfo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width:400px;">
        <div class="modal-content">
            <div class="modal-body">
                <div class="portlet box green">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-gift"></i>附件上传
                        </div>
                    </div>
                    <div class="portlet-body form">
                        <!-- BEGIN FORM-->
                        <div class="form-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <form id="fileupload" action="@Url.Action("UploadConfirmPaper", "Collecting")" method="POST" enctype="multipart/form-data">
                                        <div class="portlet-body form">
                                            <!-- BEGIN FORM-->
                                            <div class="form-body">
                                                <div class="row">
                                                    <!--/span-->
                                                    <div class="col-md-4">
                                                        <div class="form-group">
                                                            <div class="fileinput fileinput-new" data-provides="fileinput">
                                                                <div class="input-group input-large">
                                                                    <div class="form-control uneditable-input input-fixed input-small" data-trigger="fileinput">
                                                                        <i class="fa fa-file fileinput-exists"></i>&nbsp;
                                                                        <span class="fileinput-filename"> </span>
                                                                    </div>
                                                                    <span class="input-group-addon btn default btn-file">
                                                                        <span class="fileinput-new">选择文件</span>
                                                                        <span class="fileinput-exists">替换</span>
                                                                        <input type="file" name="file">
                                                                    </span>
                                                                    <a href="javascript:;" class="input-group-addon btn red fileinput-exists" data-dismiss="fileinput">删除</a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-actions">
                                            <div class="text-center">
                                                <button class="btn green btn-sm padding-lf-15">上传</button>
                                                <button type="button" id="dissmissUpload" class="btn yellow btn-sm padding-lf-15" data-dismiss="modal">返回</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts{
    <script src=@Url.Content("~/assets/global/plugins/bootstrap-select/js/bootstrap-select.min.js") type="text/javascript"></script>
    <script type="text/javascript">

        var addCollectingProduct = function (product) {
            var collectingModal = $('#collectingModal');
            collectingModal.modal('show');
            collectingModal.find("form").attr("action", "@Url.Action("Create", "Collecting")");
            clearFormValues("collectingModal");
            setFormValues(product);
        };

        $(document).ready(function () {
            $('#CollectingDate').datetimepicker({
                autoclose: true,
                todayBtn: true,
                language: "zh-CN",
                format: 'yyyy-mm-dd',
                minView: 2,
                todayHighlight: true,
            });

            $('#CollectingDate').on('change', function() {
                var collectingDate = $(this).val();
                $('#collecting-date-to-submit').val(collectingDate);
            });

            $("#ConfirmAdd").click(function () {
                var url = '@Url.Action("SubmitCollectingProducts", "Collecting")';
                $('#collectingProducts').attr("action", url).submit();
            });

            // 附件上传弹出层
            $("#uploadShow").click(function () {
                var uploadInfo = $('#uploadInfo');
                uploadInfo.modal('show');
                clearFormValues("uploadInfo");
            });

            $("#fileupload").submit(function () {
                var $form = $(this);
                var formData = new FormData($form[0]);
                if ($("#fileupload input[type=file]").val() === "") {
                    $.bootstrapGrowl("请选择上传文件!", {
                        type: "warning",
                        offset: {
                            from: "top",
                            amount: 150
                        },
                        align: "center"
                    });
                    return false;
                }
                var url = $form.attr("action");
                @*formData.append("OrderId", "@Model.PurchaseOrder.Id");*@
                //postCommand(url, formData, $form);
                $.ajax({
                    type: 'POST',
                    url: url,
                    data: formData,
                    cache: false,
                    processData: false, // 不处理发送的数据，因为data值是Formdata对象，不需要对数据做处理
                    contentType: false, // 不设置Content-type请求头
                    success: function(data) {
                        var $file = $('#displayFile');
                        $file.attr("href", data.FilePath.substring(1, data.FilePath.length));
                        $file.text(data.FileName);
                        $('#fileName').val(data.FileName);
                        $('#dissmissUpload').click();
                    },
                    error: function() {}
                });
                return false;
            });
        });
    </script>
}